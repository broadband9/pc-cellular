{% extends "base.html" %}
{% block title %}Repairs{% endblock %}
{% block content %}
{% load custom_filters %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom" style="margin-top: 60px">
    <h1 class="h2">Repairs</h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <button type="button" class="btn btn-sm btn-outline-light" data-bs-toggle="modal" data-bs-target="#addRepairModal">
            <i class="fas fa-plus"></i> Add New Repair
        </button>
    </div>
</div>

<div class="table-responsive">
    <table class="table table-dark table-hover table-bordered table-striped table-sm rounded" >
        <thead class="table-dark">
            <tr>
                <th style="width: 150px;">Repair Number</th>
                <th style="width: 200px;">Customer</th>
                <th style="width: 120px;">Device Type</th>
                <th style="width: 150px;">Status</th>
                <!-- <th style="width: 150px;">Signature</th> -->

                <th style="width: 150px;">Location</th>
                <th style="width: 150px;">Estimated Cost</th>
                <th style="width: 200px;">Created At</th>
                <th style="width: 200px;">Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for repair in repairs %}
            <tr>
                <td>{{ repair.passcode }}</td>
                <td>{{ repair.customer.first_name }} {{ repair.customer.last_name }}</td>
                <td>{{ repair.device_type }}</td>
                <td>{{ repair.status.name }}</td>
                <!-- <td>

                    {% if repair.signature %}
                        <div class="mt-2">
                            <img src="{{ repair.signature.url }}" alt="Signature" class="img-fluid" style="max-height: 100px; max-width: 100px;">
                        </div>
                    {% else %}
                        <div class="text-muted">No signature</div>
                    {% endif %}
                </td> -->
                <td>{{ repair.location.name }}</td>
                <td>{{ repair.estimated_cost }}</td>
                <td>{{ repair.created_at|date:"M d, Y H:i" }}</td>
                <td>

                    <button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#editRepairModal{{ repair.id }}">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn btn-sm btn-danger" data-bs-toggle="modal" data-bs-target="#deleteRepairModal{{ repair.id }}">
                        <i class="fas fa-trash"></i>
                    </button>
                    <button class="btn btn-sm btn-info" data-bs-toggle="modal" data-bs-target="#viewRepairModal{{ repair.id }}">
                        <i class="fas fa-eye"></i>
                    </button>
                    <button class="btn btn-sm btn-info" onclick="printLabel('{{ repair.repair_number }}')">
                        <i class="fas fa-print"></i>
                    </button>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
<nav aria-label="Repairs log pagination">
    <ul class="pagination justify-content-center">
        {% if repairs.has_previous %}
            <li class="page-item">
                <a class="page-link bg-dark text-light border-secondary" href="?page=1">&laquo; First</a>
            </li>
            <li class="page-item">
                <a class="page-link bg-dark text-light border-secondary" href="?page={{ repairs.previous_page_number }}">Previous</a>
            </li>
        {% endif %}

        <li class="page-item disabled">
            <span class="page-link bg-dark text-light border-secondary">Page {{ repairs.number }} of {{ repairs.paginator.num_pages }}</span>
        </li>

        {% if repairs.has_next %}
            <li class="page-item">
                <a class="page-link bg-dark text-light border-secondary" href="?page={{ repairs.next_page_number }}">Next</a>
            </li>
            <li class="page-item">
                <a class="page-link bg-dark text-light border-secondary" href="?page={{ repairs.paginator.num_pages }}">Last &raquo;</a>
            </li>
        {% endif %}
    </ul>
</nav>
<div id="printArea" style="display: none;">
    <div style="text-align: center; font-size: 24px; padding: 20px;">
        <p id="repairNumberLabel"></p>
    </div>
</div>
<script>

// function printLabel(repairNumber) {
//     const now = new Date();
//     const time = now.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true });
//     const parts = repairNumber.split("-");
//     const date = parts[3] + "/" + parts[2] + "/" + parts[1];
//     const customer = parts[4];
//     const passCode = parts[5];

//     // Create print container
//     const printContainer = document.createElement('div');
//     printContainer.innerHTML = `
//         <style>
//             @page { 
//                 size: 34mm 92mm; 
//                 margin: 0; 
//             }
//             body { 
//                 font-family: Arial, sans-serif; 
//                 font-size: 10px; 
//                 margin: 0; 
//                 padding: 0; 
//                 display: flex; 
//                 justify-content: center; 
//                 align-items: center; 
//                 height: 100vh; 
//             }
//             .content { 
//                 width: 92mm; 
//                 height: 34mm; 
//                 display: flex; 
//                 justify-content: center; 
//                 align-items: center; 
//                 text-align: center; 
//                 overflow: hidden; 
//             }
//             .content p { 
//                 margin: 0; 
//                 padding: 2mm; 
//                 font-weight: bold; 
//                 white-space: nowrap; 
//                 writing-mode: vertical-rl; 
//                 transform: rotate(180deg); 
//                 font-size: 14px; 
//             }
//         </style>
//         <div class="content">
//             <p>Date: ${date}</p>
//             <p>Time: ${time}</p>
//             <p>Customer: ${customer}</p>
//             <p>Pass code: ${passCode}</p>
//         </div>
//     `;

//     // Append to body
//     document.body.appendChild(printContainer);

//     // Trigger print
//     window.print();

//     // Cleanup after printing
//     setTimeout(() => {
//         document.body.removeChild(printContainer);
//     }, 500);
// }

// function printLabel(repairNumber) {
//     const now = new Date();
//     const time = now.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true });
//     const parts = repairNumber.split("-");
//     const date = parts[3] + "/" + parts[2] + "/" + parts[1];
//     const customer = parts[4];
//     const passCode = parts[5];

//     const htmlContent = `
//         <html>
//             <head>
//                 <title>Print Label</title>
//                 <style>
//                     @page { 
//                         size: 34mm 92mm; 
//                         margin: 0; 
//                     }
//                     body { 
//                         font-family: Arial, sans-serif; 
//                         font-size: 10px; 
//                         margin: 0; 
//                         padding: 0; 
//                         display: flex; 
//                         justify-content: center; 
//                         align-items: center; 
//                         height: 100vh; 
//                     }
//                     .content { 
//                         width: 92mm; 
//                         height: 34mm; 
//                         display: flex; 
//                         justify-content: center; 
//                         align-items: center; 
//                         text-align: center; 
//                         overflow: hidden; 
//                     }
//                     .content p { 
//                         margin: 0; 
//                         padding: 2mm; 
//                         font-weight: bold; 
//                         white-space: nowrap; 
//                         writing-mode: vertical-rl; 
//                         transform: rotate(180deg); 
//                         font-size: 14px; 
//                     }
//                 </style>
//             </head>
//             <body>
//                 <div class="content">
//                     <p>Date: ${date}</p>
//                     <p>Time: ${time}</p>
//                     <p>Customer: ${customer}</p>
//                     <p>Pass code: ${passCode}</p>
//                 </div>
//             </body>
//         </html>
//     `;

//     const iframe = document.createElement('iframe');
//     iframe.style.position = 'fixed';
//     iframe.style.right = '0';
//     iframe.style.bottom = '0';
//     iframe.style.width = '0';
//     iframe.style.height = '0';
//     iframe.style.border = 'none';
//     document.body.appendChild(iframe);

//     iframe.contentDocument.write(htmlContent);
//     iframe.contentDocument.close();

//     iframe.contentWindow.onload = () => {
//         setTimeout(() => {
//             iframe.contentWindow.focus();
//             iframe.contentWindow.print();
//             document.body.removeChild(iframe);
//         }, 1000); // Increased delay to ensure content loads
//     };
// }

<!--function printHtml(html) {-->
<!--  // Create an iframe element-->
<!--  const iframe = document.createElement('iframe');-->
<!--  iframe.style.position = 'absolute';-->
<!--  iframe.style.width = '0';-->
<!--  iframe.style.height = '0';-->
<!--  iframe.style.border = 'none';-->

<!--  // Append the iframe to the body-->
<!--  document.body.appendChild(iframe);-->

<!--  // Write the content to the iframe-->
<!--  const doc = iframe.contentWindow?.document;-->
<!--  if (doc) {-->
<!--    doc.open();-->
<!--    doc.write(html);-->
<!--    doc.close();-->
<!--  }-->

<!--  // we need to use the print this way to be able to print in phones-->
<!--  setTimeout(() => {-->
<!--    window[0].focus();-->
<!--    window[0].print();-->
<!--    setTimeout(() => {-->
<!--      document.body.removeChild(iframe); // Clean up by removing-->
<!--    }, 500);-->
<!--  }, 500);-->
<!--}-->

function printHtml(html) {
  const iframe = document.createElement('iframe');
  iframe.style.position = 'absolute';
  iframe.style.width = '0';
  iframe.style.height = '0';
  iframe.style.border = 'none';
  document.body.appendChild(iframe);

  const doc = iframe.contentWindow?.document;
  if (doc) {
    doc.open();
    doc.write(html);
    doc.close();
  }

  setTimeout(() => {
    // Use the iframe's contentWindow to print
    iframe.contentWindow?.print();
    setTimeout(() => {
      document.body.removeChild(iframe);
    }, 500);
  }, 500);
}


function printLabel(repairNumber) {
    const now = new Date();
    const time = now.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true });
    const parts = repairNumber.split("-");
    const date = parts[3] + "/" + parts[2] + "/" + parts[1];
    const customer12 = parts[4];
    const passCode = parts[5];

    const htmlContent = `
        <html>
            <head>
                <title>Print Label</title>
                <style>
                    @page { 
                        size: 34mm 92mm; 
                        margin: 0; 
                    }
                    body { 
                        font-family: Arial, sans-serif; 
                        font-size: 10px; 
                        margin: 0; 
                        padding: 0; 
                        display: flex; 
                        justify-content: center; 
                        align-items: center; 
                        height: 100vh; 
                    }
                    .content { 
                        width: 92mm; 
                        height: 34mm; 
                        display: flex; 
                        justify-content: center; 
                        align-items: center; 
                        text-align: center; 
                        overflow: hidden; 
                    }
                    .content p { 
                        margin: 0; 
                        padding: 2mm; 
                        font-weight: bold; 
                        white-space: nowrap; 
                        writing-mode: vertical-rl; 
                        transform: rotate(180deg); 
                        font-size: 14px; 
                    }
                </style>
            </head>
            <body>
                <div class="content">
                    <p>Date: ${date}</p>
                    <p>Time: ${time}</p>
                    <p>Customer: ${customer12}</p>
                    <p>Pass code: ${passCode}</p>
                </div>
            </body>
        </html>
    `;

    printHtml(htmlContent); // Call the workaround function
}

</script>

   <!-- Add Customer Modal -->
<div class="modal fade" id="addCustomerModal" tabindex="-1" aria-labelledby="addCustomerModalLabel" aria-hidden="true" style="z-index: 1100">
    <div class="modal-dialog">
        <div class="modal-content bg-dark text-light">
            <div class="modal-header">
                <h5 class="modal-title" id="addCustomerModalLabel">Add New Customer</h5>
                <button type="button" class="btn-close btn-close-white" onclick="close_customer_modal()"></button>
            </div>
            <div class="modal-body">
                <form id="addCustomerForm">
                    <div class="mb-3">
                        <label for="first_name" class="form-label">First Name</label>
                        <input type="text" class="form-control bg-dark text-light border-secondary" id="first_name" name="first_name" required>
                        <div class="invalid-feedback">Only alphabets are allowed.</div>
                    </div>
                    <div class="mb-3">
                        <label for="last_name" class="form-label">Last Name</label>
                        <input type="text" class="form-control bg-dark text-light border-secondary" id="last_name" name="last_name" required>
                        <div class="invalid-feedback">Only alphabets are allowed.</div>
                    </div>
                    <div class="mb-3">
                        <label for="email" class="form-label">Email</label>
                        <input type="email" class="form-control bg-dark text-light border-secondary" id="email" name="email">
                        <div class="invalid-feedback">Enter a valid email address.</div>
                    </div>
                    <div class="mb-3">
                        <label for="phone" class="form-label">Phone</label>
                        <input type="tel" class="form-control bg-dark text-light border-secondary" id="phone" name="phone" maxlength="15" required>
                        <div class="invalid-feedback">Phone number should contain only numbers.</div>
                    </div>
                    <div class="mb-3">
                        <label for="postcode" class="form-label">Post Code</label>
                        <input type="tel" class="form-control bg-dark text-light border-secondary" id="postcode" name="postcode" >
                        <div class="invalid-feedback">Postcode should be alphanumeric.</div>
                    </div>
                    <button type="submit" class="btn btn-primary">Add Customer</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Add Repair Modal -->
<div class="modal fade" id="addRepairModal" tabindex="-1" aria-labelledby="addRepairModalLabel" aria-hidden="true" >
    <div class="modal-dialog modal-dialog-scrollable modal-lg">
        <div class="modal-content bg-dark text-light">
            <div class="modal-header">
                <h5 class="modal-title" id="addRepairModalLabel">Add New Repair</h5>
                <button type="button" class="btn-close btn-close-white" onclick="refreshPage()" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form method="post" action="{% url 'add_repair' %}" enctype="multipart/form-data">
                    {% csrf_token %}
                    <!-- Form Fields -->
                    <h4 class="mb-3">Device Info</h4>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="customer" class="form-label">Customer</label>
                            <select class="form-control bg-dark text-light border-secondary" id="customer" name="customer" required>
                                <option value="">Select Customer</option>
                                <option value="add-new">Add New Customer</option>
                                {% for customer in customers %}
                                    <option value="{{ customer.id }}">{{ customer.first_name }} {{ customer.last_name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <script>

        const customerDropdown = document.getElementById('customer');
        const parentModalElement = document.getElementById('addRepairModal');
        const childModalElement = document.getElementById('addCustomerModal');
  const addCustomerModal = new bootstrap.Modal(document.getElementById('addCustomerModal'));
        customerDropdown.addEventListener('change', function () {
            const selectedValue = this.value;
            if (selectedValue === "add-new") {
            // Show "Add New Customer" modal
            const modalId = "addCustomerModal";
                const modalElement = document.getElementById(modalId);
                const modalInstance = new bootstrap.Modal(modalElement);
                modalInstance.show();
<!--                parentModalElement.classList.remove('show');-->
    parentModalElement.setAttribute('aria-hidden', 'true');
    parentModalElement.style.display = 'none';
       addCustomerModal.show();
       childModalElement.focus();
        }
        });
        const addCustomerForm = document.getElementById('addCustomerForm');
    addCustomerForm.addEventListener('submit', function (e) {
        e.preventDefault();
        let isValid = true;
        // First Name Validation
        const firstName = document.getElementById('first_name');
        if (!/^[A-Za-z]+$/.test(firstName.value.trim())) {
            firstName.classList.add('is-invalid');
            isValid = false;
        } else {
            firstName.classList.remove('is-invalid');
        }

        // Last Name Validation
        const lastName = document.getElementById('last_name');
        if (!/^[A-Za-z]+$/.test(lastName.value.trim())) {
            lastName.classList.add('is-invalid');
            isValid = false;
        } else {
            lastName.classList.remove('is-invalid');
        }

        // Email Validation
        const email = document.getElementById('email');
        if (email.value.trim() !== "" && !/^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/.test(email.value.trim())) {
            email.classList.add('is-invalid');
            isValid = false;
        } else {
            email.classList.remove('is-invalid');
        }

        // Phone Validation (+ and numbers only)
        const phone = document.getElementById('phone');
        if (!/^\+?\d{1,15}$/.test(phone.value.trim())) {  
            phone.classList.add('is-invalid');  
            isValid = false;  
        } else {  
            phone.classList.remove('is-invalid');  
        }

        // Postcode Validation (Alphanumeric only)
        const postcode = document.getElementById('postcode');
        if (postcode.value.trim() !== "" && !/^[A-Za-z0-9]+$/.test(postcode.value.trim())) {
            postcode.classList.add('is-invalid');
            isValid = false;
        } else {
            postcode.classList.remove('is-invalid');
        }
        console.log("isValid", isValid)
        if (!isValid){
            return
        }
        // Gather form data
        const formData = new FormData(this);

        // Save customer via API or backend
        fetch('/repairs/add-customer/', {
            method: 'POST',
            body: formData,
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Add new customer to the dropdown
                const newOption = document.createElement('option');
                newOption.value = data.customer.id;
                newOption.textContent = `${data.customer.first_name} ${data.customer.last_name}`;
                customerDropdown.appendChild(newOption);

                // Auto-select the new customer
                customerDropdown.value = data.customer.id;

                // Hide the modal
                addCustomerModal.hide();
                parentModalElement.classList.add('show');
                parentModalElement.removeAttribute('aria-hidden');
                parentModalElement.style.display = 'block';
                alert("Customer added successfully.")
                // Focus back on parent modal
                parentModalElement.focus();

                // Optionally clear the form
                addCustomerForm.reset();
            } else {
                alert(data.error);
            }
        })
        .catch(error => {
            console.error('Error adding customer:', error);
            alert('Error adding customer:', error);
        });
    });
function close_customer_modal(){
                document.getElementById("customer").value = ""
                addCustomerModal.hide();
                parentModalElement.classList.add('show');
                parentModalElement.removeAttribute('aria-hidden');
                parentModalElement.style.display = 'block';

                // Focus back on parent modal
                parentModalElement.focus();
}

</script>
                        <div class="col-md-6 mb-3">
                            <label for="device_type" class="form-label">Device Type</label>
                            <select class="form-control bg-dark text-light border-secondary" id="device_type" name="device_type" required>
                                <option value="">Select Device Type</option>
                                <option value="Mobile">Mobile</option>
                                <option value="Tablet">Tablet</option>
                                <option value="Laptop">Laptop</option>

                            </select>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="make" class="form-label">Make</label>
                            <select class="form-control bg-dark text-light border-secondary" id="make" name="make" required>
                                {% for make in makes %}
                                    <option value="{{ make.id }}">{{ make.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="model" class="form-label">Model</label>
                            <input type="text" class="form-control bg-dark text-light border-secondary" id="model" name="model" required>
                        </div>
                    </div>
                    
               <div id="mobile-tablet-fields" class="d-none">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="imei" class="form-label">IMEI</label>
                                <input type="text" class="form-control bg-dark text-light border-secondary" id="imei" name="imei">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="network" class="form-label">Network</label>
                                <select class="form-control bg-dark text-light border-secondary" id="network" name="network">
                                    <option value="vodafone">Vodafone</option>
                                    <option value="other">Other</option>
                                </select>
                            </div>
                        </div>
                        <!-- Mobile/Tablet Yes/No Fields -->
                        <div class="row">
                            <h4>Diagnostic Data</h4>
                            {% for field in mob_yes %}
                                {% if forloop.counter0|divisibleby:2 %}
                                    </div><div class="row mb-3">
                                {% endif %}
                                <div class="col-md-6">
                                    <label class="form-label">{{ field|replace_underscores }}</label>
                                    <div class="d-flex">
                                        <div class="form-check me-3">
                                            <input class="form-check-input" type="radio" name="{{ field }}" id="{{ field }}-yes" value="True">
                                            <label class="form-check-label" for="{{ field }}-yes">Yes</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="radio" name="{{ field }}" id="{{ field }}-no" value="False" checked>
                                            <label class="form-check-label" for="{{ field }}-no">No</label>
                                        </div>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                    <div id="laptop-fields" style="display: none;">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="operating_system" class="form-label">Operating System</label>
                                <input type="text" class="form-control bg-dark text-light border-secondary" id="operating_system" name="operating_system">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="ram" class="form-label">RAM</label>
                                <input type="text" class="form-control bg-dark text-light border-secondary" id="ram" name="ram">
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="storage" class="form-label">Storage</label>
                                <input type="text" class="form-control bg-dark text-light border-secondary" id="storage" name="storage">
                            </div>
                        </div>

                        <!-- Laptop Yes/No Fields -->
                         <div class="row"> 
                            <h4>Diagnostic Data</h4>

                        {% for field in lap_yes %}
                        {% if forloop.counter0|divisibleby:2 %}
                    </div><div class="row mb-3">
                    {% endif %}
                            <div class="col-md-6">
                                <label class="form-label">{{ field|replace_underscores }}</label>
                                <div class="d-flex">
                                    <div class="form-check me-3">
                                        <input class="form-check-input" type="radio" name="{{ field }}" id="{{ field }}-yes" value="True">
                                        <label class="form-check-label" for="{{ field }}-yes">Yes</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="{{ field }}" id="{{ field }}-no" value="False" checked>
                                        <label class="form-check-label" for="{{ field }}-no">No</label>
                                    </div>
                                </div>
                            </div>
                        
                        {% endfor %}
                    </div>
                </div>
                <h4 id="diagnost_add">Diagnostic Data</h4>
                    <div class="row">
                    
                    <!-- General Yes/No Fields -->
                    {% for field in mandatory_yes %}
                    {% if forloop.counter0|divisibleby:2 %}
                                    </div><div class="row mb-3">
                                {% endif %}
                        <div class="col-md-6">
                            <label class="form-label">{{ field|replace_underscores }}</label>
                            <div class="d-flex">
                                <div class="form-check me-3">
                                    <input class="form-check-input" type="radio" name="{{ field }}" id="{{ field }}-yes" value="True">
                                    <label class="form-check-label" for="{{ field }}-yes">Yes</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="{{ field }}" id="{{ field }}-no" value="False" checked>
                                    <label class="form-check-label" for="{{ field }}-no">No</label>
                                </div>
                            </div>
                        </div>
                    
                    {% endfor %}
                    </div>
                    <script>
    document.addEventListener('DOMContentLoaded', function () {
        document.getElementById('device_type').addEventListener('change', function () {
            const deviceType = this.value;
            const mobileTabletFields = document.getElementById('mobile-tablet-fields');
            const laptopFields = document.getElementById('laptop-fields');
            console.log("device_type", deviceType)
            if (deviceType === 'Mobile' || deviceType === 'Tablet') {
                laptopFields.classList.add('d-none');
                mobileTabletFields.classList.remove('d-none');
                mobileTabletFields.classList.add('d-block');
                document.getElementById("diagnost_add").style.display = "none";
                
                
            }

            else if (deviceType === 'Laptop') {
                
                laptopFields.classList.remove('d-none');
                laptopFields.classList.add('d-block');
                mobileTabletFields.classList.remove('d-block');
                mobileTabletFields.classList.add('d-none');                // document.getElementById("diagnost_add").style.display = "none";
            }
            else if(deviceType ===  ""){
                document.getElementById("diagnost_add").style.display = "block";
                laptopFields.classList.remove('d-block');
                laptopFields.classList.add('d-none');
                mobileTabletFields.classList.remove('d-block');
                mobileTabletFields.classList.add('d-none'); 
            }
            // else{
            //     document.getElementById("diagnost_add").style.display = "block";
            // }
        });
        
        const siteToLocations = {
        {% for site in locations %}
            "{{ site.id }}": [
                {% for location in site.locations.all %}
                    { "id": "{{ location.id }}", "name": "{{ location.name }}" },
                {% endfor %}
            ],
        {% endfor %}
    };
    document.getElementById('site').addEventListener('change', function () {
        const siteId = this.value; // Get the selected site ID
        const locationDropdown = document.getElementById('location');

        // Clear existing options
        locationDropdown.innerHTML = '<option value="" disabled selected>Select a Location</option>';

        // Populate new options
        if (siteToLocations[siteId]) {
            siteToLocations[siteId].forEach(location => {
                const option = document.createElement('option');
                option.value = location.id;
                option.textContent = location.name;
                locationDropdown.appendChild(option);
            });
        }
    });
    });
</script>
<h4>Repair Status</h4>
<div class="row">
    <div class="col-md-6 mb-3">
        <label for="status" class="form-label">Status</label>
        <select class="form-control bg-dark text-light border-secondary" id="status" name="status" required>
            {% for status in statuses %}
                <option value="{{ status.id }}">{{ status.name }}</option>
            {% endfor %}
        </select>
    </div>

        <div class="col-md-6 mb-3">
            <label for="passcode" class="form-label">Passcode</label>
            <input type="number" step="0.01" class="form-control bg-dark text-light border-secondary" id="passcode" name="passcode" required>
        </div>

</div>
                
                <div class="row">
                    <div class="col-md-6 mb-3">
                    <label for="location" class="form-label">Site</label>
                        <select class="form-control bg-dark text-light border-secondary" id="site" name="site" required>
                            <option value="">Select a Site</option>
                            {% for site in locations %}
                                <option value="{{ site.id }}">{{ site.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-6 mb-3">
                    <label for="location" class="form-label">Location</label>
                        <select class="form-control bg-dark text-light border-secondary" id="location" name="location" required>
                            <option value="" disabled selected>Select a Location</option>
                        </select>
                    </div>
                    </div>
                    <h4>Costs</h4>
                    <div class="row">

                        <div class="col-md-6 mb-3">
                            <label for="estimated_cost" class="form-label">Estimated Cost</label>
                            <input type="number" step="0.01" class="form-control bg-dark text-light border-secondary" id="estimated_cost" name="estimated_cost" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="finalized_price" class="form-label">Finalized Cost</label>
                            <input type="number" step="0.01" class="form-control bg-dark text-light border-secondary" id="finalized_price" name="finalized_price">
                        </div>
                    </div>
                    <div class="row">
                        <div class="col mb-3">
                            <label for="issue_description" class="form-label">Issue Description</label>
                            <textarea class="form-control bg-dark text-light border-secondary" id="issue_description" name="issue_description" rows="3" required></textarea>
                        </div>
                    </div>
                    <!-- Estimated Cost and Signature -->
                    <div class="row">
                         <div class="col-md-6 mb-3">
                            <label for="signatureCanvas_add" class="form-label">Signature</label>
                            <div class="signature-container border bg-light p-3 rounded">
                                <canvas id="signatureCanvas_add" class="w-100" height="150"></canvas>
                                <button type="button" class="btn btn-secondary btn-sm mt-2" id="clearCanvas_add">Clear Signature</button>
                                <input type="hidden" id="signatureImage_add" name="signatureImage_add">
                            </div>
                        </div>
                        
                    </div>


                    <!-- Submit Button -->
                    <div class="mb-3">
                        <button type="submit" class="btn btn-primary w-100">Add Repair</button>
                    </div>
                </form>
            </div>
            <div class="modal-footer" style="margin-top: auto;"></div>
        </div>
    </div>
</div>


<!-- View modals for each repair -->
{% for repair in repairs %}
<div class="modal fade" id="viewRepairModal{{ repair.id }}" tabindex="-1" aria-labelledby="viewRepairModal{{ repair.id }}" aria-hidden="true">
    <div class="modal-dialog modal-dialog-scrollable modal-lg">
        <div class="modal-content bg-dark text-light">
            <div class="modal-header">
                <h5 class="modal-title" id="viewRepairModalLabel{{ repair.id }}">View Repair</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form>

                    <!-- Customer and Device Type -->
                     <h4>Device Info</h4>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="customer{{ repair.id }}" class="form-label">Customer</label>
                            <input type="text" class="form-control bg-dark text-light border-secondary" id="customer{{ repair.id }}" name="customer" value="{{ repair.customer.first_name }} {{ repair.customer.last_name }}" disabled>
                        </div>


                        <div class="col-md-6 mb-3">
                            <label for="device_type{{ repair.id }}" class="form-label">Device Type</label>
                            <input type="text" class="form-control bg-dark text-light border-secondary" id="device_type{{ repair.id }}" name="device_type" value="{{ repair.device_type }}" disabled>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="make{{ repair.id }}" class="form-label">Make</label>
                            <select class="form-control bg-dark text-light border-secondary" id="make1{{ repair.id }}" name="make" disabled>
                                {% for make in makes %}
                                    <option value="{{ make.id }}" {% if make.id == repair.make.id %}selected{% endif %}>{{ make.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="model{{ repair.id }}" class="form-label">Model</label>
                            <input type="text" class="form-control bg-dark text-light border-secondary" id="model1{{ repair.id }}" name="model" value="{{ repair.model }}" disabled>
                        </div>
                    </div>
                    <!-- Status and Location -->
                    
                    {% if repair.device_type == 'Mobile' or repair.device_type == 'Tablet' %}
                    <div id="mobile-tablet1{{ repair.id }}" >
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="imei{{ repair.id }}" class="form-label">IMEI</label>
                                <input type="text" class="form-control bg-dark text-light border-secondary" id="imei1{{ repair.id }}" name="imei" value="{{ repair.imei }}" disabled>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="network{{ repair.id }}" class="form-label">Network</label>
                                <select class="form-control bg-dark text-light border-secondary" id="network1{{ repair.id }}" name="network" disabled>
                                    <option value="vodafone" {% if repair.network == 'vodafone' %}selected{% endif %}>Vodafone</option>
                                    <option value="other" {% if repair.network == 'other' %}selected{% endif %}>Other</option>
                                </select>
                            </div>
                        </div>
                        <h4>Diagnostic Data</h4>
                        <!-- Mobile/Tablet Yes/No Fields -->
                         <div class="row">
                        {% for field in mob_yes %}
                        {% if forloop.counter0|divisibleby:2 %}
                        </div><div class="row mb-3">
                    {% endif %}
                        
                            <div class="col-md-6">
                                <label class="form-label">{{ field|replace_underscores }}</label>
                                <div class="d-flex">
                                    <div class="form-check me-3">
                                        <input class="form-check-input" type="radio" name="{{ field }}" id="{{ field }}1-yes{{ repair.id }}" value="True" {% if repair|get_item:field == True %}checked{% endif %} disabled>
                                        <label class="form-check-label" for="{{ field }}-yes{{ repair.id }}">Yes</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="{{ field }}" id="{{ field }}1-no{{ repair.id }}" value="False" {% if repair|get_item:field == False %}checked{% endif %} disabled>
                                        <label class="form-check-label" for="{{ field }}-no{{ repair.id }}">No</label>
                                    </div>
                                </div>
                            </div>
                        
                        {% endfor %}
                    </div>
                    {% endif %}
                    {% if repair.device_type == 'Laptop' %}
                    <div id="laptop1{{ repair.id }}">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="operating_system{{ repair.id }}" class="form-label">Operating System</label>
                                <input type="text" class="form-control bg-dark text-light border-secondary" id="operating_system1{{ repair.id }}" name="operating_system" value="{{ repair.operating_system }}" disabled>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="ram{{ repair.id }}" class="form-label">RAM</label>
                                <input type="text" class="form-control bg-dark text-light border-secondary" id="ram1{{ repair.id }}" name="ram" value="{{ repair.ram }}" disabled>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="storage{{ repair.id }}" class="form-label">Storage</label>
                                <input type="text" class="form-control bg-dark text-light border-secondary" id="storage1{{ repair.id }}" name="storage" value="{{ repair.storage }}" disabled>
                            </div>
                        </div>
                        
                        <h4>Diagnostic Data</h4>
                        <div class="row">
                        <!-- Laptop Yes/No Fields -->
                        {% for field in lap_yes %}
                        {% if forloop.counter0|divisibleby:2 %}
            </div><div class="row mb-3">
        {% endif %}
                            <div class="col-md-6">
                                <label class="form-label">{{ field|replace_underscores }}</label>
                                <div class="d-flex">
                                    <div class="form-check me-3">
                                        <input class="form-check-input" type="radio" name="{{ field }}" id="{{ field }}1-yes{{ repair.id }}" value="True" {% if repair|get_item:field == True %}checked{% endif %} disabled>
                                        <label class="form-check-label" for="{{ field }}-yes{{ repair.id }}">Yes</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="{{ field }}" id="{{ field }}1-no{{ repair.id }}" value="False" {% if repair|get_item:field == False %}checked{% endif %} disabled>
                                        <label class="form-check-label" for="{{ field }}-no{{ repair.id }}">No</label>
                                    </div>
                                </div>
                            </div>
                        
                        {% endfor %} 
                    </div>
                    </div>
                    {% endif %}
                    <!-- General Yes/No Fields -->
                     <div class="row">
                    {% for field in mandatory_yes %}
                    {% if forloop.counter0|divisibleby:2 %}
                        </div><div class="row mb-3">
                    {% endif %}
                        <div class="col-md-6">
                            <label class="form-label">{{ field|replace_underscores }}</label>
                            <div class="d-flex">
                                <div class="form-check me-3">
                                    <input class="form-check-input" type="radio" name="{{ field }}" id="{{ field }}1-yes{{ repair.id }}" value="True" {% if repair|get_item:field == True %}checked{% endif %} disabled>
                                    <label class="form-check-label" for="{{ field }}-yes{{ repair.id }}">Yes</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="{{ field }}" id="{{ field }}1-no{{ repair.id }}" value="False" {% if repair|get_item:field == False %}checked{% endif %} disabled>
                                    <label class="form-check-label" for="{{ field }}-no{{ repair.id }}">No</label>
                                </div>
                            </div>
                        </div>
                    
                    {% endfor %}
                </div>
                    <!-- Make and Model -->
                     <h4>Repair Status</h4>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="status{{ repair.id }}" class="form-label">Status</label>
                            <select class="form-control bg-dark text-light border-secondary" id="statusview{{ repair.id }}" name="statusview" required>
                                {% for status in statuses %}
                                    <option value="{{ status.id }}" {% if status.id == repair.status.id %}selected{% endif %}>{{ status.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="passcode{{ repair.id }}" class="form-label">Passcode</label>
                            <input type="number" step="0.01" class="form-control bg-dark text-light border-secondary" id="passcode1{{ repair.id }}" name="passcode" value="{{ repair.passcode }}" disabled>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="location{{ repair.id }}" class="form-label">Sites</label>
                            <input type="text" class="form-control bg-dark text-light border-secondary" id="viewsite{{ repair.id }}" name="site" value="{{ repair.site.name }}" disabled>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="location{{ repair.id }}" class="form-label">Location</label>
                            <select class="form-control bg-dark text-light border-secondary" id="locationview{{ repair.id }}" name="locationview" required>
                                {% for location in repair.site.locations.all %}
                                    <option value="{{ location.id }}" {% if location.id == repair.location.id %}selected{% endif %}>{{ location.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    <!-- Issue Description and Estimated Cost -->
                     <h4>Costs</h4>
                    <div class="row">

                        <div class="col-md-6 mb-3">
                            <label for="estimated_cost{{ repair.id }}" class="form-label">Estimated Cost</label>
                            <input type="number" step="0.01" class="form-control bg-dark text-light border-secondary" id="estimated_cost1{{ repair.id }}" name="estimated_cost" value="{{ repair.estimated_cost }}" disabled>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="finalized_price{{ repair.id }}" class="form-label">Finalized Cost</label>
                            <input type="number" step="0.01" class="form-control bg-dark text-light border-secondary" id="finalized_price1{{ repair.id }}" name="finalized_priceview" value="{{ repair.finalized_price }}" >
                        </div>
                    </div>
                    <!-- Finalized Price and Signature -->
                    <div class="row">
                        <div class="col mb-3">
                            <label for="issue_description{{ repair.id }}" class="form-label">Issue Description</label>
                            <textarea class="form-control bg-dark text-light border-secondary" id="issue_description1{{ repair.id }}" name="issue_description" rows="3" disabled>{{ repair.issue_description }}</textarea>
                        </div>

                    </div>
<div class="row">
    <h4>Technician Notes</h4>
        
    
        <!-- Loop to display existing notes for each repair -->
         <div id="note{{repair.id}}">
        {% for note_data in repair.technicianNotes.notes %}

    <div id="note{{ repair.id }}-{{ forloop.counter }}" class="card border-dark bg-dark text-light">
        <div class="card-body">
            <!-- Note text -->
            <p class="text-light-50">
                <strong>Note #{{ forloop.counter }}:</strong>
            </p>
            <p class="form-control bg-dark text-light border-secondary" id="note-text{{ repair.id }}-{{ forloop.counter }}">
                 {{ note_data.note }}
            </p>

            <!-- Attributes row -->
            <div class="d-flex flex-wrap align-items-center text-light-50">
                {% if note_data.user %}
                    <small class="me-3 d-flex align-items-center">
                        <i class="fa fa-user me-1"></i> {{ note_data.user }}
                    </small>
                {% endif %}

                <small class="me-3 d-flex align-items-center">
                    <i class="fa fa-clock me-1"></i> {{ note_data.time|slice:":16" }}
                </small>

                <small class="d-flex align-items-center">
                    <i class="fa fa-envelope me-1"></i>
                    {% if note_data.send_email and note_data.send_sms %}
                        Email & SMS
                    {% elif note_data.send_email %}
                        Email
                    {% elif note_data.send_sms %}
                        SMS
                    {% else %}
                        Not Sent
                    {% endif %}
                </small>


            <!-- Changes in the same row -->
            {% if note_data.changes %}
                <div class="d-flex flex-wrap mt-2" style="margin-left:10px">
                    <p class="mb-1 me-1"><strong>Changes:</strong></p>
                    <ul class="list-inline mb-0">
                        {% for change in note_data.changes %}
                            <li class="list-inline-item">
                                <strong>{{ change.field }}:</strong> {{ change.before }} → {{ change.after }}
                            </li>
                        {% endfor %}
                    </ul>
                </div>
            {% endif %}
                </div>
        </div>
    </div>
{% empty %}
    <p id="no-notes-message" class="form-control bg-dark text-light border-secondary mb-2">
        No notes available.
    </p>
{% endfor %}
</div>
        <div class="mt-2"> <!-- Add margin-top for spacing -->
        <label for="new_notes" class="form-label">New Notes:</label>
    </div>

        <!-- Dynamic notes list for each repair -->
        <div id="dynamic-notes-{{ repair.id }}"></div>
        <!-- Text area for adding a new note, scoped to repair.id -->
        <div id="note-input-container-{{ repair.id }}" class="mt-2">
            <textarea class="form-control bg-dark text-light border-secondary mb-2" id="new-note-{{ repair.id }}" placeholder="Write your note here"></textarea>
            <div id="actions-container-{{ repair.id }}" class="row mt-2">
                <div class=" mb-3 col-md-6">
                    <input type="checkbox" class="form-check-input" id="sendAsSms-{{repair.id}}" name="sendAsSms">
                    <label for="sendAsSms-{{repair.id}}" class="form-check-label">Send as SMS</label>
                </div>
                <div class=" mb-3 col-md-6">
                    <input type="checkbox" class="form-check-input" id="sendAsEmail-{{repair.id}}" name="sendAsEmail">
                    <label for="sendAsEmail-{{repair.id}}" class="form-check-label">Send as Email</label>
                </div>
            </div>
            <button type="button" class="btn btn-success btn-sm mt-1" onclick="addNote({{ repair.id }})">Done</button>
        </div>


        <!-- <div id="actions-container-{{ repair.id }}" class="row mt-2 d-none">
                        <div class=" mb-3 col-md-6">
                            <input type="checkbox" class="form-check-input" id="sendAsSms-{{repair.id}}" name="sendAsSms">
                            <label for="sendAsSms-{{repair.id}}" class="form-check-label">Send as SMS</label>
                        </div>
                        <div class=" mb-3 col-md-6">
                            <input type="checkbox" class="form-check-input" id="sendAsEmail-{{repair.id}}" name="sendAsEmail">
                            <label for="sendAsEmail-{{repair.id}}" class="form-check-label">Send as Email</label>
                        </div>
                    </div> -->
    </div>
</div>

<!-- Save Changes button -->
<div class="row">
    <!-- <div class="col-12"> -->
        <button type="button" id="save-changes-{{ repair.id }}" class="btn btn-primary mt-2" onclick="saveChanges({{ repair.id }})">Done Changes</button>
    <!-- </div> -->
</div>


                </form>
            </div>
        </div>
    </div>
</div>
{% endfor %}
<!-- Edit and Delete modals for each repair -->
{% for repair in repairs %}
<div class="modal fade" id="editRepairModal{{ repair.id }}" tabindex="-1" aria-labelledby="editRepairModalLabel{{ repair.id }}" aria-hidden="true">
    <div class="modal-dialog modal-dialog-scrollable modal-lg">
        <div class="modal-content bg-dark text-light">
            <div class="modal-header">
                <h5 class="modal-title" id="editRepairModalLabel{{ repair.id }}">Edit Repair</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form method="post" action="{% url 'edit_repair' repair.id %}">
                    {% csrf_token %}
                    <!-- Customer and Device Type -->
                     <h4>Device Info</h4>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="customer{{ repair.id }}" class="form-label">Customer</label>
                            <select class="form-control bg-dark text-light border-secondary" id="customer{{ repair.id }}" name="customer"  required>
                                {% for customer in customers %}
                                    <option value="{{ customer.id }}" {% if customer.id == repair.customer.id %}selected{% endif %}>{{ customer.first_name }} {{customer.last_name}}</option>
                                {% endfor %}
                            </select>
                        </div>


                        <div class="col-md-6 mb-3">
                            <label for="device_type{{ repair.id }}" class="form-label">Device Type</label>
                            <input type="text" class="form-control bg-dark text-light border-secondary" id="device_type{{ repair.id }}" name="device_type" value="{{ repair.device_type }}" disabled>
                        </div>
                    </div>
                    <!-- Make and Model -->
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="make{{ repair.id }}" class="form-label">Make</label>
                            <select class="form-control bg-dark text-light border-secondary" id="make{{ repair.id }}" name="make" required>
                                {% for make in makes %}
                                    <option value="{{ make.id }}" {% if make.id == repair.make.id %}selected{% endif %}>{{ make.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="model{{ repair.id }}" class="form-label">Model</label>
                            <input type="text" class="form-control bg-dark text-light border-secondary" id="model{{ repair.id }}" name="model" value="{{ repair.model }}" required>
                        </div>
                    </div>
                    
                    <script>
    document.getElementById('site{{ repair.id }}').addEventListener('change', function () {
        const siteId = this.value; // Get the selected site ID
        const locationDropdown = document.getElementById('location{{ repair.id }}');

        // Clear existing options
        locationDropdown.innerHTML = '<option value="" disabled selected>Select a Location</option>';

        // Populate new options
        if (siteToLocations[siteId]) {
            siteToLocations[siteId].forEach(location => {
                const option = document.createElement('option');
                option.value = location.id;
                option.textContent = location.name;
                locationDropdown.appendChild(option);
            });
        }
    });
</script>

                    {% if repair.device_type == 'Mobile' or repair.device_type == 'Tablet' %}
                    <div id="mobile-tablet{{ repair.id }}" >
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="imei{{ repair.id }}" class="form-label">IMEI</label>
                                <input type="text" class="form-control bg-dark text-light border-secondary" id="imei{{ repair.id }}" name="imei" value="{{ repair.imei }}">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="network{{ repair.id }}" class="form-label">Network</label>
                                <select class="form-control bg-dark text-light border-secondary" id="network{{ repair.id }}" name="network">
                                    <option value="vodafone" {% if repair.network == 'vodafone' %}selected{% endif %}>Vodafone</option>
                                    <option value="other" {% if repair.network == 'other' %}selected{% endif %}>Other</option>
                                </select>
                            </div>
                        </div>
                        <!-- Mobile/Tablet Yes/No Fields -->
                        <h4>Diagnostic Data</h4>
                        <div class="row">
                        {% for field in mob_yes %}
                        {% if forloop.counter0|divisibleby:2 %}
                        </div><div class="row mb-3">
                    {% endif %}
                            <div class="col-md-6">
                                <label class="form-label">{{ field|replace_underscores }}</label>
                                <div class="d-flex">
                                    <div class="form-check me-3">
                                        <input class="form-check-input" type="radio" name="{{ field }}" id="{{ field }}-yes{{ repair.id }}" value="True" {% if repair|get_item:field == True %}checked{% endif %}>
                                        <label class="form-check-label" for="{{ field }}-yes{{ repair.id }}">Yes</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="{{ field }}" id="{{ field }}-no{{ repair.id }}" value="False" {% if repair|get_item:field == False %}checked{% endif %}>
                                        <label class="form-check-label" for="{{ field }}-no{{ repair.id }}">No</label>
                                    </div>
                                </div>
                            </div>
                        
                        {% endfor %}
                    </div>
                    </div>
                    {% endif %}
                    {% if repair.device_type == 'Laptop' %}
                    <div id="laptop-f{{ repair.id }}">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="operating_system{{ repair.id }}" class="form-label">Operating System</label>
                                <input type="text" class="form-control bg-dark text-light border-secondary" id="operating_system{{ repair.id }}" name="operating_system" value="{{ repair.operating_system }}">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="ram{{ repair.id }}" class="form-label">RAM</label>
                                <input type="text" class="form-control bg-dark text-light border-secondary" id="ram{{ repair.id }}" name="ram" value="{{ repair.ram }}">
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="storage{{ repair.id }}" class="form-label">Storage</label>
                                <input type="text" class="form-control bg-dark text-light border-secondary" id="storage{{ repair.id }}" name="storage" value="{{ repair.storage }}">
                            </div>
                        </div>
                        <h4>Diagnostic Data</h4>
                        <!-- Laptop Yes/No Fields -->
                     <div class="row">
                        {% for field in lap_yes %}
                        {% if forloop.counter0|divisibleby:2 %}
                        </div><div class="row mb-3">
                    {% endif %}
                            <div class="col-md-6">
                                <label class="form-label">{{ field|replace_underscores }}</label>
                                <div class="d-flex">
                                    <div class="form-check me-3">
                                        <input class="form-check-input" type="radio" name="{{ field }}" id="{{ field }}-yes{{ repair.id }}" value="True" {% if repair|get_item:field == True %}checked{% endif %}>
                                        <label class="form-check-label" for="{{ field }}-yes{{ repair.id }}">Yes</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="{{ field }}" id="{{ field }}-no{{ repair.id }}" value="False" {% if repair|get_item:field == False %}checked{% endif %}>
                                        <label class="form-check-label" for="{{ field }}-no{{ repair.id }}">No</label>
                                    </div>
                                </div>
                            </div>
                        
                        {% endfor %}
                    </div>
                </div>
                    {% endif %}
                    <!-- General Yes/No Fields -->
                     <div class="row">
                    {% for field in mandatory_yes %}
                    {% if forloop.counter0|divisibleby:2 %}
                        </div><div class="row mb-3">
                    {% endif %}
                        <div class="col-md-6">
                            <label class="form-label">{{ field|replace_underscores }}</label>
                            <div class="d-flex">
                                <div class="form-check me-3">
                                    <input class="form-check-input" type="radio" name="{{ field }}" id="{{ field }}-yes{{ repair.id }}" value="True" {% if repair|get_item:field == True %}checked{% endif %}>
                                    <label class="form-check-label" for="{{ field }}-yes{{ repair.id }}">Yes</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="{{ field }}" id="{{ field }}-no{{ repair.id }}" value="False" {% if repair|get_item:field == False %}checked{% endif %}>
                                    <label class="form-check-label" for="{{ field }}-no{{ repair.id }}">No</label>
                                </div>
                            </div>
                        </div>
                    
                    {% endfor %}
                </div>
                    <h4>Repair Status</h4>
                    <!-- Status and Location -->
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="status{{ repair.id }}" class="form-label">Status</label>
                            <select class="form-control bg-dark text-light border-secondary" id="status{{ repair.id }}" name="status" required>
                                {% for status in statuses %}
                                    <option value="{{ status.id }}" {% if status.id == repair.status.id %}selected{% endif %}>{{ status.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="passcode{{ repair.id }}" class="form-label">Passcode</label>
                            <input type="number" step="0.01" class="form-control bg-dark text-light border-secondary" id="passcode{{ repair.id }}" name="passcode" value="{{ repair.passcode }}" disabled>
                        </div>

                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="location{{ repair.id }}" class="form-label">Site</label>
                            <select class="form-control bg-dark text-light border-secondary" id="site{{ repair.id }}" name="site" required>
                                {% for site in locations %}
                                    <option value="{{ site.id }}" {% if site.id == repair.site.id %}selected{% endif %}>{{ site.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="location{{ repair.id }}" class="form-label">Location</label>
                            <select class="form-control bg-dark text-light border-secondary" id="location{{ repair.id }}" name="location" required>
                                {% for location in repair.site.locations.all %}
                                <option value="{{ location.id }}" {% if location.id == repair.location.id %}selected{% endif %}>{{ location.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    <!-- Issue Description and Estimated Cost -->
                     <h4>Costs</h4>
                    <div class="row">

                        <div class="col-md-6 mb-3">
                            <label for="estimated_cost{{ repair.id }}" class="form-label">Estimated Cost</label>
                            <input type="number" step="0.01" class="form-control bg-dark text-light border-secondary" id="estimated_cost{{ repair.id }}" name="estimated_cost" value="{{ repair.estimated_cost }}" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="finalized_price{{ repair.id }}" class="form-label">Finalized Cost</label>
                            <input type="number" step="0.01" class="form-control bg-dark text-light border-secondary" id="finalized_price{{ repair.id }}" name="finalized_price" value="{{ repair.finalized_price }}">
                        </div>
                    </div>
                    <!-- Finalized Price and Signature -->
                    <div class="row">
                        <div class="col mb-3">
                            <label for="issue_description{{ repair.id }}" class="form-label">Issue Description</label>
                            <textarea class="form-control bg-dark text-light border-secondary" id="issue_description{{ repair.id }}" name="issue_description" rows="3" required>{{ repair.issue_description }}</textarea>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="signatureCanvas{{ repair.id }}" class="form-label">Signature</label>
                            <div class="signature-container border bg-light p-3 rounded">
                                <canvas id="signatureCanvas{{ repair.id }}" class="w-100" height="150"></canvas>
                                <button type="button" class="btn btn-secondary btn-sm mt-2" id="clearCanvas{{ repair.id }}">Clear Signature</button>
                                <input type="hidden" id="signatureImage{{ repair.id }}" name="signature_image" value="{{ repair.signature_image }}">
                            </div>
                        </div>
                        

                    </div>
                    <!-- Submit Button -->
                    <div class="mb-3">
                        <button type="submit" class="btn btn-primary w-100">Save Changes</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>



    <!-- Delete Repair Modal -->
    <div class="modal fade" id="deleteRepairModal{{ repair.id }}" tabindex="-1" aria-labelledby="deleteRepairModalLabel{{ repair.id }}" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content bg-dark text-light">
                <div class="modal-header">
                    <h5 class="modal-title" id="deleteRepairModalLabel{{ repair.id }}">Delete Repair</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>Are you sure you want to delete this repair?</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <form method="post" action="{% url 'delete_repair' repair.id %}">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-danger">Delete</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
<script>
     document.addEventListener('DOMContentLoaded', function() {
        const canvas = document.getElementById('signatureCanvas_add');
const ctx = canvas.getContext('2d');
const clearButton = document.getElementById('clearCanvas_add');
const signatureInput = document.getElementById('signatureImage_add');

let drawing = false;

canvas.addEventListener('mousedown', (e) => {
    drawing = true;
    const rect = canvas.getBoundingClientRect();
    ctx.beginPath(); // Start a new path
    ctx.moveTo(e.clientX - rect.left, e.clientY - rect.top); // Move to the starting point
});

canvas.addEventListener('mousemove', (e) => {
    if (!drawing) return;
    const rect = canvas.getBoundingClientRect();
    ctx.lineTo(e.clientX - rect.left, e.clientY - rect.top); // Draw a line to the new point
    ctx.stroke();
});

canvas.addEventListener('mouseup', () => {
    drawing = false;
    signatureInput.value = canvas.toDataURL('image/png'); // Save the signature as a base64 image
});

canvas.addEventListener('mouseleave', () => {
    drawing = false; // Stop drawing if the mouse leaves the canvas
});

clearButton.addEventListener('click', () => {
    ctx.clearRect(0, 0, canvas.width, canvas.height); // Clear the canvas
    signatureInput.value = ''; // Reset the hidden input
});
{% for repair in repairs %}
    const canvas{{ repair.id }} = document.getElementById('signatureCanvas{{ repair.id }}');
    const ctx{{ repair.id }} = canvas{{ repair.id }}.getContext('2d');
    const clearButton{{ repair.id }} = document.getElementById('clearCanvas{{ repair.id }}');
    const signatureInput{{ repair.id }} = document.getElementById('signatureImage{{ repair.id }}');

    let drawing{{ repair.id }} = false;

    canvas{{ repair.id }}.addEventListener('mousedown', (e) => {
        drawing{{ repair.id }} = true;
        const rect = canvas{{ repair.id }}.getBoundingClientRect();
        ctx{{ repair.id }}.beginPath(); // Start a new path
        ctx{{ repair.id }}.moveTo(e.clientX - rect.left, e.clientY - rect.top); // Move to the starting point
    });

    canvas{{ repair.id }}.addEventListener('mousemove', (e) => {
        if (!drawing{{ repair.id }}) return;
        const rect = canvas{{ repair.id }}.getBoundingClientRect();
        ctx{{ repair.id }}.lineTo(e.clientX - rect.left, e.clientY - rect.top); // Draw a line to the new point
        ctx{{ repair.id }}.stroke();
    });

    canvas{{ repair.id }}.addEventListener('mouseup', () => {
        drawing{{ repair.id }} = false;
        signatureInput{{ repair.id }}.value = canvas{{ repair.id }}.toDataURL('image/png'); // Save the signature as a base64 image
    });

    canvas{{ repair.id }}.addEventListener('mouseleave', () => {
        drawing{{ repair.id }} = false; // Stop drawing if the mouse leaves the canvas
    });

    clearButton{{ repair.id }}.addEventListener('click', () => {
        ctx{{ repair.id }}.clearRect(0, 0, canvas{{ repair.id }}.width, canvas{{ repair.id }}.height); // Clear the canvas
        signatureInput{{ repair.id }}.value = ''; // Reset the hidden input
    });
{% endfor %}
     });
   

</script>
{% endfor %}
<script>
    // Store the new notes
    let repairNotes = {}; // Store notes per repairId

// Show the text area for adding a note for a specific repair
function showNoteInput(repairId) {
    console.log("in add note for repair", repairId);
    document.getElementById("note-input-container-" + repairId).classList.remove("d-none");
}

// Add the note to the list for a specific repair
function addNote(repairId) {
    const newNote = document.getElementById("new-note-" + repairId).value.trim();
    if (newNote) {
        // Add the note to the repair's notes array
        if (!repairNotes[repairId]) {
            repairNotes[repairId] = [];
        }
        repairNotes[repairId].push(newNote);
        const status = document.getElementById(`statusview${repairId}`).value;
    const locationElement  = document.getElementById(`locationview${repairId}`).value;
    const finalizedElement  = document.getElementById(`finalized_price1${repairId}`).value;

    const send_sms  = document.getElementById(`sendAsSms-${repairId}`).checked;
    const send_email  = document.getElementById(`sendAsEmail-${repairId}`).checked;
    console.log("location_ element", locationElement, send_sms, send_email)
    let allNotes = [...(repairNotes[repairId] || [])]; // Start with the new notes

    // Get existing notes from the DOM that are not part of newNotes
    const existingNotes = [...document.querySelectorAll(`#dynamic-notes-${repairId} p`)].map(p => p.textContent);

    // Filter out notes that are already in newNotes (to prevent duplicates)
    const filteredExistingNotes = existingNotes.filter(note => !repairNotes[repairId]?.includes(note));

    // Combine new notes with filtered existing notes
    allNotes = allNotes.concat(filteredExistingNotes);

    console.log("all notes", allNotes);

        // Send the notes to the backend
        fetch('/repairs/save-notes/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}',
            },
            body: JSON.stringify({
                repair_id: repairId, // Send the repair id
                notes: allNotes,
                finalized: finalizedElement,
                status: status, // Include selected status
                location1: locationElement, // Include selected location
                send_sms: send_sms,
                send_email: send_email
            }),
        })
        .then(response => response.json())
        .then(data => {
    if (data.success) {
        alert("Notes saved successfully!");
        console.log("data", data);

        const notesDiv = document.getElementById('note' + repairId);

        // Clear the notesDiv before appending new notes
        notesDiv.innerHTML = "";

        if (data.data && data.data.length > 0) {
            // Loop through the notes and create cards
            data.data.forEach((note, index) => {
                // Create card container
                const cardDiv = document.createElement('div');
                cardDiv.classList.add('card', 'border-dark', 'bg-dark', 'text-light', 'mb-3');
                cardDiv.id = `note${index + 1}`;

                // Create card body
                const cardBody = document.createElement('div');
                cardBody.classList.add('card-body');

                // Add Note #
                const noteNumber = document.createElement('p');
                noteNumber.classList.add('text-light-50', 'mb-2');
                noteNumber.innerHTML = `<strong>Note #${index + 1}:</strong>`;
                cardBody.appendChild(noteNumber);

                // Add Note Text
                const noteText = document.createElement('p');
                noteText.classList.add('form-control', 'bg-dark', 'text-light', 'border-secondary', 'mb-2');
                noteText.id = `note-text-${index}`;
                noteText.textContent = note.note || 'No note provided.';
                cardBody.appendChild(noteText);

                // Attributes row
                const attributesRow = document.createElement('div');
                attributesRow.classList.add('d-flex', 'flex-wrap', 'align-items-center', 'text-light-50', 'mb-2');

                // Add User (if available)
                if (note.user) {
                    const userText = document.createElement('small');
                    userText.classList.add('me-3', 'd-flex', 'align-items-center');
                    userText.innerHTML = `<i class="fa fa-user me-1"></i> ${note.user}`;
                    attributesRow.appendChild(userText);
                }

                // Add Date and Time
                const dateTime = document.createElement('small');
                dateTime.classList.add('me-3', 'd-flex', 'align-items-center');
                dateTime.innerHTML = `<i class="fa fa-clock me-1"></i> ${note.time ? note.time.slice(0, 16) : 'N/A'}`;
                attributesRow.appendChild(dateTime);

                // Add Delivery Method
                const deliveryMethod = document.createElement('small');
                deliveryMethod.classList.add('d-flex', 'align-items-center');
                let deliveryText = `<i class="fa fa-envelope me-1"></i> `;
                if (note.send_email && note.send_sms) {
                    deliveryText += 'Email & SMS';
                } else if (note.send_email) {
                    deliveryText += 'Email';
                } else if (note.send_sms) {
                    deliveryText += 'SMS';
                } else {
                    deliveryText += 'Not Sent';
                }
                deliveryMethod.innerHTML = deliveryText;
                attributesRow.appendChild(deliveryMethod);

                // cardBody.appendChild(attributesRow);

                // Add Changes (if available)
                if (note.changes && note.changes.length > 0) {
                    const changesDiv = document.createElement('div');
                    changesDiv.classList.add('d-flex', 'flex-wrap', 'mt-2');
                    changesDiv.style.marginLeft = '10px';

                    const changesTitle = document.createElement('p');
                    changesTitle.classList.add('mb-1', 'me-1');
                    changesTitle.innerHTML = '<strong>Changes:</strong>';
                    changesDiv.appendChild(changesTitle);

                    const changesList = document.createElement('ul');
                    changesList.classList.add('list-inline', 'mb-0');

                    note.changes.forEach(change => {
                        const changeItem = document.createElement('li');
                        changeItem.classList.add('list-inline-item');
                        changeItem.innerHTML = `<strong>${change.field}:</strong> ${change.before} → ${change.after}`;
                        changesList.appendChild(changeItem);
                    });

                    changesDiv.appendChild(changesList);
                    attributesRow.appendChild(changesDiv);
                }
                cardBody.appendChild(attributesRow);

                cardDiv.appendChild(cardBody);
                notesDiv.appendChild(cardDiv);
                
            });

        } else {
            // If no notes, add a <p> tag with the value "No notes"
            const pTag = document.createElement('p');
            pTag.textContent = "No notes"; // Text to display if there are no notes
            notesDiv.appendChild(pTag); // Append the <p> tag to the notes div
        }
        
        removeNoteAndClear(repairId)
    } else {
        alert("Failed to save notes. Please try again.");
    }
})
.catch(error => console.error('Error:', error));


//         // Create a new note container with Edit and Delete buttons
//         const dynamicNotesDiv = document.getElementById("dynamic-notes-" + repairId);
//         const noteElement = document.createElement("div");
//         noteElement.className = "note-container";
//         noteElement.innerHTML = `
//             <p class="form-control bg-dark text-light border-secondary mb-2">${newNote}</p>
//             <button type="button" class="btn btn-sm btn-warning" onclick="editNewNote(${repairId})">Edit</button>
//             <button type="button" class="btn btn-sm btn-danger" onclick="deleteNewNote(${repairId})">Delete</button>
//         `;
//         dynamicNotesDiv.appendChild(noteElement);

//         // Hide the input area and clear it
//         document.getElementById("new-note-" + repairId).value = "";
// <!--        document.getElementById("note-input-container-" + repairId).classList.add("d-none");-->
//         toggleActionButtons(repairId, true);
//         // Hide the "No notes available" message if new notes are added
//         document.getElementById("no-notes-message-" + repairId)?.classList.add("d-none");
    } else {
        alert("Please write a note before clicking Done.");
    }
}

// Edit a new note for a specific repair
function editNewNote(repairId) {
    const noteElement = event.target.parentElement.querySelector("p");
    if (!noteElement) {
        console.error("Note element not found!");
        return;
    }

    const noteText = noteElement.textContent;
    const noteContainer = noteElement.parentElement;

    // Change the note to an input field with the current note value
    noteElement.outerHTML = `
        <input type="text" class="form-control bg-dark text-light border-secondary mb-2" value="${noteText}" id="edit-new-note-${repairId}" />
    `;

    // Hide the "Edit" button and show "Done"
    const editButton = event.target;
    editButton.style.display = 'none';

    const doneButton = document.createElement("button");
    doneButton.type = "button";
    doneButton.className = "btn btn-sm btn-success";
    doneButton.textContent = "Done";
    doneButton.onclick = () => saveNewNote(repairId, noteContainer);

    noteContainer.appendChild(doneButton);
}

// Save the edited new note for a specific repair
function saveNewNote(repairId, noteContainer) {
    const editedNote = document.getElementById("edit-new-note-" + repairId).value.trim();
    if (editedNote) {
        const noteElement = document.querySelector("#edit-new-note-" + repairId);
        if (!noteElement) {
            console.error("Input element not found!");
            return;
        }

        noteElement.outerHTML = `
            <p class="form-control bg-dark text-light border-secondary mb-2">${editedNote}</p>
        `;

        // Update the repair's notes array with the edited note
        const index = Array.from(document.querySelectorAll("#dynamic-notes-" + repairId + " .note-container")).indexOf(noteContainer);
        if (index !== -1) {
            repairNotes[repairId][index] = editedNote; // Update the array with the edited note
        } else {
            console.error("Index for repairNotes not found!");
        }

        // Remove the "Done" button and enable the "Edit" button again
        const doneButton = noteContainer.querySelector(".btn-success");
        doneButton.remove();

        const editButton = document.createElement("button");
        editButton.type = "button";
        editButton.className = "btn btn-sm btn-warning";
        editButton.textContent = "Edit";
        editButton.onclick = () => editNewNote(repairId);
        noteContainer.appendChild(editButton);
    }
}

// Delete a new note for a specific repair
function deleteNewNote(repairId) {
    const noteElement = event.target.parentElement;

    let noteText = noteElement.textContent
        .replace(/Edit/g, '') // Remove "Edit"
        .replace(/Delete/g, '') // Remove "Delete"
        .trim(); // Trim extra spaces

    console.log("Cleaned Note Text to Delete:", noteText); // Debugging

    // Remove the note element from the UI
    noteElement.remove();

    // Remove the note from the repairNotes dictionary
    if (repairNotes[repairId]) {
        repairNotes[repairId] = repairNotes[repairId].filter(note => note !== noteText);
    }
    // If no dynamic notes exist, show "No notes available" message
    if (document.getElementById("dynamic-notes-" + repairId).children.length === 0) {
        document.getElementById("no-notes-message-" + repairId)?.classList.remove("d-none");
    }
    if (!repairNotes[repairId] || repairNotes[repairId].length === 0) {
        toggleActionButtons(repairId, false);
    }
}

// Save changes (send notes to the backend) for a specific repair
function saveChanges(repairId) {
    window.location.reload()
// const status = document.getElementById(`statusview${repairId}`).value;
//     const locationElement  = document.getElementById(`locationview${repairId}`).value;
//     const send_sms  = document.getElementById(`sendAsSms-${repairId}`).checked;
//     const send_email  = document.getElementById(`sendAsEmail-${repairId}`).checked;
//     console.log("location_ element", locationElement, send_sms, send_email)
//     let allNotes = [...(repairNotes[repairId] || [])]; // Start with the new notes

//     // Get existing notes from the DOM that are not part of newNotes
//     const existingNotes = [...document.querySelectorAll(`#dynamic-notes-${repairId} p`)].map(p => p.textContent);

//     // Filter out notes that are already in newNotes (to prevent duplicates)
//     const filteredExistingNotes = existingNotes.filter(note => !repairNotes[repairId]?.includes(note));

//     // Combine new notes with filtered existing notes
//     allNotes = allNotes.concat(filteredExistingNotes);

//     console.log("all notes", allNotes);

//         // Send the notes to the backend
//         fetch('/repairs/save-notes/', {
//             method: 'POST',
//             headers: {
//                 'Content-Type': 'application/json',
//                 'X-CSRFToken': '{{ csrf_token }}',
//             },
//             body: JSON.stringify({
//                 repair_id: repairId, // Send the repair id
//                 notes: allNotes,
//                 status: status, // Include selected status
//                 location1: locationElement, // Include selected location
//                 send_sms: send_sms,
//                 send_email: send_email
//             }),
//         })
//         .then(response => response.json())
//         .then(data => {
//             if (data.success) {
//                 alert("Notes saved successfully!");
//                 location.reload(); // Reload the page to fetch the updated notes
//             } else {
//                 alert("Failed to save notes. Please try again.");
//             }
//         })
//         .catch(error => console.error('Error:', error));

}
    function toggleActionButtons(repairId, show) {
    const actionsContainer = document.getElementById(`actions-container-${repairId}`);
    const saveButton = document.getElementById(`save-changes-${repairId}`);

    if (show) {
        actionsContainer.classList.remove('d-none');
        saveButton.classList.remove('d-none');
    } else {
        actionsContainer.classList.add('d-none');
        saveButton.classList.add('d-none');
    }

}
function handleOutsideClick(event) {
    const modal = document.getElementById('addRepairModal');
    const secondmodal = document.getElementById('addCustomerModal');
    // Check if the modal is open and if the click is outside the modal
    console.log("test", modal.classList.contains('show'))
    if (modal.classList.contains('show') && !modal.contains(event.target)) {
        console.log("in condition", !secondmodal.contains(event.target))
         if (!secondmodal.contains(event.target)){
            console.log("in second modal")
            close_customer_modal();
        }
    }
}
function removeNoteAndClear(repairId) {
    // Get the value of the text area
    const textArea = document.getElementById("new-note-" + repairId);
    if (textArea) {
        const noteText = textArea.value.trim(); // Get and trim the text area value

        // Check if the note exists in the dictionary
        if (repairNotes[repairId]) {
            // Remove the note from the dictionary
            repairNotes[repairId] = repairNotes[repairId].filter(note => note !== noteText);
        }

        // Clear the text area value
        textArea.value = "";
    }
}

// Add event listener to the document to listen for clicks outside the modal
document.addEventListener('click', handleOutsideClick);
    function refreshPage() {
        window.location.reload(); // Reloads the current page
    }
    </script>

{% endblock %}
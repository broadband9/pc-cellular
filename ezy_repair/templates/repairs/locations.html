{% extends "base.html" %}
{% block title %}Sites{% endblock %}
{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom" style="margin-top: 60px">
    <h1 class="h2">Sites</h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <button type="button" class="btn btn-sm btn-outline-light" data-bs-toggle="modal" data-bs-target="#addSiteModal">
            <i class="fas fa-plus"></i> Add New Site
        </button>
    </div>
</div>

<div class="table-responsive">
    <table class="table table-dark table-hover table-bordered table-striped table-sm">
        <thead class="table-dark">
            <tr>
                <th>#</th>
                <th>Site Name</th>
                <th>Locations</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for site in locations %}
            <tr>
                <td>{{ site.id }}</td>
                <td>{{ site.name }}</td>
                <td>
                    <ul>
                        {% for location in site.locations.all %}
                        <li>{{ location.name }}</li>
                        {% endfor %}
                    </ul>
                </td>
                <td>
                    <button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#editSiteModal{{ site.id }}">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn btn-sm btn-danger" data-bs-toggle="modal" data-bs-target="#deleteSiteModal{{ site.id }}">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
<nav aria-label="Repairs log pagination">
    <ul class="pagination justify-content-center">
        {% if locations.has_previous %}
            <li class="page-item">
                <a class="page-link bg-dark text-light border-secondary" href="?page=1">&laquo; First</a>
            </li>
            <li class="page-item">
                <a class="page-link bg-dark text-light border-secondary" href="?page={{ locations.previous_page_number }}">Previous</a>
            </li>
        {% endif %}

        <li class="page-item disabled">
            <span class="page-link bg-dark text-light border-secondary">Page {{ locations.number }} of {{ locations.paginator.num_pages }}</span>
        </li>

        {% if locations.has_next %}
            <li class="page-item">
                <a class="page-link bg-dark text-light border-secondary" href="?page={{ locations.next_page_number }}">Next</a>
            </li>
            <li class="page-item">
                <a class="page-link bg-dark text-light border-secondary" href="?page={{ locations.paginator.num_pages }}">Last &raquo;</a>
            </li>
        {% endif %}
    </ul>
</nav>

<!-- Add Site Modal -->
<div class="modal fade" id="addSiteModal" tabindex="-1" aria-labelledby="addSiteModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content bg-dark text-light">
            <div class="modal-header">
                <h5 class="modal-title" id="addSiteModalLabel">Add New Site</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form method="post" action="{% url 'add_location' %}">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label for="site_name" class="form-label">Site Name</label>
                        <input type="text" class="form-control bg-dark text-light border-secondary" id="site_name" name="name" required>
                    </div>
                    <div id="locationsContainer">
                        <div class="mb-3">
                            <label for="location1" class="form-label">Location 1</label>
                            <input type="text" class="form-control bg-dark text-light border-secondary" id="location1" name="locations[]" required>
                        </div>
                    </div>
                    <button type="button" class="btn btn-secondary " onclick="addLocationField()">Add Another Location</button>
                    <button type="submit" class="btn btn-primary">Add Site</button>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
function addLocationField() {
    const container = document.getElementById('locationsContainer');
    const count = container.children.length + 1;
    const newField = `
        <div class="mb-3">
            <label for="location${count}" class="form-label">Location ${count}</label>
            <input type="text" class="form-control bg-dark text-light border-secondary" id="location${count}" name="locations[]" required>
        </div>`;
    container.insertAdjacentHTML('beforeend', newField);
}
</script>

<!-- Edit and Delete modals for each site -->
{% for site in locations %}
    <!-- Edit Site Modal -->
    <div class="modal fade" id="editSiteModal{{ site.id }}" tabindex="-1" aria-labelledby="editSiteModalLabel{{ site.id }}" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content bg-dark text-light">
            <div class="modal-header">
                <h5 class="modal-title" id="editSiteModalLabel{{ site.id }}">Edit Site</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form method="post" action="{% url 'edit_location' site.id %}">
                    {% csrf_token %}
                    <!-- Site Name -->
                    <div class="mb-3">
                        <label for="site_name{{ site.id }}" class="form-label">Site Name</label>
                        <input type="text" class="form-control bg-dark text-light border-secondary" id="site_name{{ site.id }}" name="name" value="{{ site.name }}" required>
                    </div>

                    <!-- Locations -->
                    <div id="locationsContainer{{ site.id }}">
                        {% for location in site.locations.all %}
                        <div class="mb-3 location-field">
                            <label for="location{{ location.id }}" class="form-label">Location {{ forloop.counter }}</label>
                            <input type="hidden" name="location_ids[]" value="{{ location.id }}">
                            <input type="text" class="form-control bg-dark text-light border-secondary" id="location{{ location.id }}" name="locations[]" value="{{ location.name }}" required>
                            <button type="button" class="btn btn-danger btn-sm" onclick="removeLocationField(this)">Remove</button>
                        </div>
                        {% endfor %}
                    </div>

                    <!-- Add New Location -->
                    <button type="button" class="btn btn-secondary " onclick="addLocationFieldToEdit({{ site.id }})">Add Another Location</button>

                    <!-- Submit -->
                    <button type="submit" class="btn btn-primary">Save Changes</button>

                </form>
            </div>
        </div>
    </div>
</div>

    <!-- Delete Site Modal -->
    <div class="modal fade" id="deleteSiteModal{{ site.id }}" tabindex="-1" aria-labelledby="deleteSiteModalLabel{{ site.id }}" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content bg-dark text-light">
                <div class="modal-header">
                    <h5 class="modal-title" id="deleteSiteModalLabel{{ site.id }}">Delete Site</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>Are you sure you want to delete the site "{{ site.name }}"?</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <form method="post" action="{% url 'delete_location' site.id %}">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-danger">Delete</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
{% endfor %}
<script>
    function removeLocationField(button) {
        const fieldContainer = button.parentElement;
        fieldContainer.remove();
    }
    function addLocationFieldToEdit(siteId) {
    const container = document.getElementById(`locationsContainer${siteId}`);
    const newFieldIndex = container.childElementCount + 1; // Increment the field count

    const newField = document.createElement('div');
    newField.classList.add('mb-3', 'location-field');
    newField.innerHTML = `
        <label for="newLocation${newFieldIndex}" class="form-label">New Location ${newFieldIndex}</label>
        <input type="text" class="form-control bg-dark text-light border-secondary" id="newLocation${newFieldIndex}" name="new_locations[]" required>
        <button type="button" class="btn btn-danger btn-sm" onclick="removeLocationField(this)">Remove</button>
    `;
    container.appendChild(newField);
}
</script>
{% endblock %}

{% extends "base.html" %}
{% block title %}Dashboard{% endblock %}
{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom text-light" style="margin-top:60px">
    <h1 class="h2">Dashboard</h1>
    <div class="row " >
    <div class="col-md-12">
        <div class="input-group">
            <input type="text" id="globalSearchInput" class="form-control bg-dark text-light border-secondary" placeholder="Search..." aria-label="Search" aria-describedby="searchButton">
            <button class="btn btn-primary" type="button" id="searchButton">Search</button>
        </div>
        <ul class="list-group mt-2" id="searchResults" style="display: none; z-index:1000; position: absolute; max-height: 200px;
        overflow-y: auto; ">
            <!-- Dynamic search results will appear here -->
        </ul>
    </div>
</div>
</div>

<!-- First Row: Total Customers -->
<div class="row row-cols-1 row-cols-md-3 g-4 mb-4">
    <div class="col">
        <div class="card text-white bg-primary">
            <div class="card-body">
                <h5 class="card-title">Total Customers</h5>
                <p class="card-text display-4">{{ customer_count }}</p>
            </div>
        </div>
    </div>
</div>

<!-- Dynamic Status Cards -->
<div class="row row-cols-1 row-cols-md-3 g-4 mb-4">
    {% for status, count in statuses.items %}
        <div class="col">
            <div class="card text-white bg-dark">
                <div class="card-body">
                    <h5 class="card-title">{{ status|title }} Repairs</h5>
                    <p class="card-text display-4">{{ count }}</p>
                </div>
            </div>
        </div>
        {% if forloop.counter|divisibleby:3 and not forloop.last %}
    </div><div class="row row-cols-1 row-cols-md-3 g-4 mb-4">
        {% endif %}
    {% endfor %}
</div>
<script>
    document.getElementById('searchButton').addEventListener('click', function() {
        const query = document.getElementById('globalSearchInput').value.trim();

        if (!query){
            searchResults.style.display = 'none';
        }

        fetch(`/repairs/api/global-search/?q=${encodeURIComponent(query)}`)
    .then(response => response.json())
    .then(data => {
        const searchResults = document.getElementById('searchResults');
        searchResults.innerHTML = ''; // Clear previous results
        searchResults.style.display = 'none';

        const results = data.results;

        if (Object.keys(results).length === 0){
        }
        const allEmpty = Object.values(results).every(list => list.length === 0);

        if (allEmpty) {
            alert("No data found");
        }

        for (const [category, items] of Object.entries(results)) {
            if (items.length === 0) continue;

            // Add a category heading
            const categoryItem = document.createElement('li');
            categoryItem.className = 'list-group-item bg-secondary text-light';
            categoryItem.textContent = category.charAt(0).toUpperCase() + category.slice(1);
            searchResults.appendChild(categoryItem);

            // Add individual items (limit to 5)
            items.forEach(item => {
                const listItem = document.createElement('li');
                listItem.className = 'list-group-item';
                listItem.textContent = item.first_name ? `${item.first_name} ${item.last_name}` : item.name || item.repair_number || item.site_name;
                listItem.style.cursor = 'pointer';

                // Attach event listener to open modal
                listItem.addEventListener('click', () => {
                    openModal(category, item);
                });

                searchResults.appendChild(listItem);
            });
        }

        searchResults.style.display = 'block';
    })
    .catch(error => console.error('Error fetching search results:', error));
    });
const globalSearchInput = document.getElementById('globalSearchInput');
const searchResults = document.getElementById('searchResults');

// Hide search results when clicking outside
document.addEventListener('click', (event) => {
    if (!globalSearchInput.contains(event.target) && !searchResults.contains(event.target)) {
        searchResults.style.display = 'none';
    }
});
    function openModal(category, data) {
        if (category === "statuses") {
        // Populate modal fields with the data
        document.getElementById('name').value = data.name || '';
        document.getElementById('description').value = data.description || '';

        // Disable the fields
        document.getElementById('name').disabled = true;
        document.getElementById('description').disabled = true;

        // Open the "statuses" modal
        const modalInstance = new bootstrap.Modal(document.getElementById('ViewStatusModal'));
        modalInstance.show();
        }
        if (category === "makes") {
        // Populate modal fields with the data
        document.getElementById('make_name').value = data.name || '';


        // Disable the fields
        document.getElementById('make_name').disabled = true;


        // Open the "statuses" modal
        const modalInstance = new bootstrap.Modal(document.getElementById('ViewMakeModal'));
        modalInstance.show();
        }
        if (category === "locations") {
        // Populate modal fields with the data
        document.getElementById('location_name').value = data.site_name || '';
        const locations = data.locations || [];

        // Format locations as a bulleted list with line breaks
        const formattedLocations = locations.map(location => `• ${location.name}`).join('\n');

        // Set the value of the textarea
        document.getElementById('address').value = formattedLocations;

        // Disable the textarea
        document.getElementById('location_name').disabled = true;
        document.getElementById('address').disabled = true;

        // Open the "statuses" modal
        const modalInstance = new bootstrap.Modal(document.getElementById('ViewLocationModal'));
        modalInstance.show();
        }
        if (category === "customers") {
        // Populate modal fields with the data
        document.getElementById('first_name').value = data.first_name || '';
        document.getElementById('last_name').value = data.last_name || '';
        document.getElementById('phone').value = data.phone || '';
        document.getElementById('postcode').value = data.postcode || '';
        document.getElementById('email').value = data.email || '';

        // Disable the fields
        document.getElementById('first_name').disabled = true;
        document.getElementById('email').disabled = true;
        document.getElementById('postcode').disabled = true;
        document.getElementById('phone').disabled = true;
        document.getElementById('last_name').disabled = true;

        // Open the "statuses" modal
        const modalInstance = new bootstrap.Modal(document.getElementById('ViewCustomerModal'));
        modalInstance.show();
        }
        if (category === "repairs") {
        // Populate modal fields with the data
        document.getElementById('customer').value = data.customer__first_name + " " + data.customer__last_name || '';
        document.getElementById('device_type').value = data.device_type || '';
        document.getElementById('status').value = data.status__id || '';
        repair_id = data.id
        document.getElementById('make').value = data.make__name || '';
        document.getElementById('model').value = data.model || '';
        document.getElementById('issue_description').value = data.issue_description || '';
        document.getElementById('estimated_cost').value = data.estimated_cost || '';
        document.getElementById('finalized_price').value = data.finalized_price || '';
        document.getElementById('site_repair').value = data.site__name || '';
        document.getElementById('passcode').value = data.passcode || '';
        const notesDiv = document.getElementById('notes'); // Get the div where you want to display notes

        // Check if technicianNotes__notes exists and has length greater than 0
        if (data.technicianNotes__notes && data.technicianNotes__notes.length > 0) {
    // Clear the notesDiv before appending
    notesDiv.innerHTML = "";

    // Loop through the notes and create cards
    data.technicianNotes__notes.forEach((note, index) => {
    // Create card container
    const cardDiv = document.createElement('div');
    cardDiv.classList.add('card', 'border-dark', 'bg-dark', 'text-light', 'mb-3');
    cardDiv.id = `note${index + 1}`;

    // Create card body
    const cardBody = document.createElement('div');
    cardBody.classList.add('card-body');

    // Add Note #
    const noteNumber = document.createElement('p');
    noteNumber.classList.add('text-light-50', 'mb-2');
    noteNumber.innerHTML = `<strong>Note #${index + 1}:</strong>`;
    cardBody.appendChild(noteNumber);

    // Add Note Text
    const noteText = document.createElement('p');
    noteText.classList.add('form-control', 'bg-dark', 'text-light', 'border-secondary', 'mb-2');
    noteText.id = `note-text-${index}`;
    noteText.textContent = note.note || 'No note provided.';
    cardBody.appendChild(noteText);

    // Attributes row
    const attributesRow = document.createElement('div');
    attributesRow.classList.add('d-flex', 'flex-wrap', 'align-items-center', 'text-light-50', 'mb-2');

    // Add User (if available)
    if (note.user) {
        const userText = document.createElement('small');
        userText.classList.add('me-3', 'd-flex', 'align-items-center');
        userText.innerHTML = `<i class="fa fa-user me-1"></i> ${note.user}`;
        attributesRow.appendChild(userText);
    }

    // Add Date and Time
    const dateTime = document.createElement('small');
    dateTime.classList.add('me-3', 'd-flex', 'align-items-center');
    dateTime.innerHTML = `<i class="fa fa-clock me-1"></i> ${note.time ? note.time.slice(0, 16) : 'N/A'}`;
    attributesRow.appendChild(dateTime);

    // Add Delivery Method
    const deliveryMethod = document.createElement('small');
    deliveryMethod.classList.add('d-flex', 'align-items-center');
    let deliveryText = `<i class="fa fa-envelope me-1"></i> `;
    if (note.send_email && note.send_sms) {
        deliveryText += 'Email & SMS';
    } else if (note.send_email) {
        deliveryText += 'Email';
    } else if (note.send_sms) {
        deliveryText += 'SMS';
    } else {
        deliveryText += 'Not Sent';
    }
    deliveryMethod.innerHTML = deliveryText;
    attributesRow.appendChild(deliveryMethod);

    // Append attributes row to card body
<!--    cardBody.appendChild(attributesRow);-->

    // Add Changes (if available)
    if (note.changes && note.changes.length > 0) {
        const changesDiv = document.createElement('div');
        changesDiv.classList.add('d-flex', 'flex-wrap', 'mt-2');
        changesDiv.style.marginLeft = '10px';

        const changesTitle = document.createElement('p');
        changesTitle.classList.add('mb-1', 'me-1');
        changesTitle.innerHTML = '<strong>Changes:</strong>';
        changesDiv.appendChild(changesTitle);

        const changesList = document.createElement('ul');
        changesList.classList.add('list-inline', 'mb-0');

        note.changes.forEach(change => {
            const changeItem = document.createElement('li');
            changeItem.classList.add('list-inline-item');
            changeItem.innerHTML = `<strong>${change.field}:</strong> ${change.before} → ${change.after}`;
            changesList.appendChild(changeItem);
        });

        changesDiv.appendChild(changesList);
        attributesRow.appendChild(changesDiv);
        cardBody.appendChild(attributesRow);
    }

    // Append card body to card container
    cardDiv.appendChild(cardBody);

    // Append the card to the container
    notesDiv.appendChild(cardDiv);
});
        } else {
            // If no notes, add a <p> tag with the value "No notes"
            const pTag = document.createElement('p');
            pTag.textContent = "No notes"; // Text to display if there are no notes
            notesDiv.appendChild(pTag); // Append the <p> tag to the notes div
        }
        if (data.tampered){
            document.getElementById('tampered-yes').checked = true
        }
        else{
            document.getElementById('tampered-no').checked = true
        }
        if (data.missing_part){
            document.getElementById('missing_part-yes').checked = true
        }
        else{
            document.getElementById('missing_part-no').checked = true
        }
        if (data.power_up){
            document.getElementById('power_up-yes').checked = true
        }
        else{
            document.getElementById('power_up-no').checked = true
        }
        if (data.liquid_damage){
            document.getElementById('liquid_damage-yes').checked = true
        }
        else{
            document.getElementById('liquid_damage-no').checked = true
        }
        if(data.device_type === "Laptop"){
            const laptopFields = document.getElementById('laptop-fields');
            laptopFields.style.display = (data.device_type === 'Laptop') ? 'block' : 'none';
            document.getElementById('operating_system').value = data.operating_system || '';
            document.getElementById('ram').value = data.ram || '';
            document.getElementById('storage').value = data.storage || '';
            document.getElementById('operating_system').disabled = true;
            document.getElementById('ram').disabled = true;
            document.getElementById('storage').disabled = true;
            if (data.trackpad_functional){
            document.getElementById('trackpad_functional-yes').checked = true
            }
            else{
                document.getElementById('trackpad_functional-no').checked = true
            }
            if (data.keyboard_functional){
                document.getElementById('keyboard_functional-yes').checked = true
            }
            else{
                document.getElementById('keyboard_functional-no').checked = true
            }
            if (data.hinge_damage){
                document.getElementById('hinge_damage-yes').checked = true
            }
            else{
                document.getElementById('hinge_damage-no').checked = true
            }
            if (data.screen_damage){
                document.getElementById('screen_damage-yes').checked = true
            }
            else{
                document.getElementById('screen_damage-no').checked = true
            }
        }
        if(data.site__id){
            const siteToLocations = {
        {% for site in locations %}
            "{{ site.id }}": [
                {% for location in site.locations.all %}
                    { "id": "{{ location.id }}", "name": "{{ location.name }}" },
                {% endfor %}
            ],
        {% endfor %}
    };
            const locationDropdown = document.getElementById('location');

        // Clear existing options
        locationDropdown.innerHTML = '<option value="" disabled selected>Select a Location</option>';
            siteToLocations[data.site__id].forEach(location => {
                const option = document.createElement('option');
                option.value = location.id;
                option.textContent = location.name;
                locationDropdown.appendChild(option);
            });
            document.getElementById('location').value = data.location__id || '';
        }
        const mobileTabletFields = document.getElementById('mobile-tablet-fields');
        if(data.device_type === "Mobile" || data.device_type === "Tablet"){
            
            mobileTabletFields.classList.remove('d-none');
            mobileTabletFields.classList.add('d-block');
            document.getElementById('network').value = data.network || '';
            document.getElementById('imei').value = data.imei || '';
            document.getElementById('imei').disabled = true;
            document.getElementById('network').disabled = true;
            if (data.risk_lcd){
            document.getElementById('risk_lcd-yes').checked = true
            }
            else{
                document.getElementById('risk_lcd-no').checked = true
            }
            if (data.sim_removed){
                document.getElementById('sim_removed-yes').checked = true
            }
            else{
                document.getElementById('sim_removed-no').checked = true
            }
            if (data.button_function_ok){
                document.getElementById('button_function_ok-yes').checked = true
            }
            else{
                document.getElementById('button_function_ok-no').checked = true
            }
            if (data.risk_biometric){
                document.getElementById('risk_biometric-yes').checked = true
            }
            else{
                document.getElementById('risk_biometric-no').checked = true
            }
            if (data.risk_back){
                document.getElementById('risk_back-yes').checked = true
            }
            else{
                document.getElementById('risk_back-no').checked = true
            }
            if (data.camera_lens_back_damage){
                document.getElementById('camera_lens_back_damage-yes').checked = true
            }
            else{
                document.getElementById('camera_lens_back_damage-no').checked = true
            }
            if (data.lens_lcd_damage){
                document.getElementById('lens_lcd_damage-yes').checked = true
            }
            else{
                document.getElementById('lens_lcd_damage-no').checked = true
            }
        }else {
                mobileTabletFields.classList.add('d-none');
                }

        // Disable the fields
        
        document.getElementById('site_repair').disabled = true;
        document.getElementById('device_type').disabled = true;
        document.getElementById('customer').disabled = true;
        document.getElementById('make').disabled = true;
        document.getElementById('issue_description').disabled = true
        document.getElementById('estimated_cost').disabled = true
        document.getElementById('passcode').disabled = true

        // Open the "statuses" modal
        const modalInstance = new bootstrap.Modal(document.getElementById('ViewRepairModal'));
        modalInstance.show();
        }
    }
</script>

<!-- Charts Section -->
<div class="row">
    <div class="col-md-8">
        <div class="card bg-dark text-light">
            <div class="card-body">
                <h5 class="card-title">Repairs Over Time</h5>
                <canvas id="repairsChart"></canvas>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card bg-dark text-light">
            <div class="card-body">
                <h5 class="card-title">Recent Activity</h5>
                <ul class="list-group list-group-flush">
                    {% for log in activity_logs %}
                        <li class="list-group-item bg-dark text-light">
                            <small  style="color: white;">{{ log.created_at|date:"M d, Y H:i" }}</small><br>
                            {{ log.description }}
                        </li>
                    {% endfor %}
                </ul>
            </div>
        </div>
    </div>
</div>

<!-- View status modal -->
<div class="modal fade" id="ViewStatusModal" tabindex="-1" aria-labelledby="viewStatusModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content bg-dark text-light">
            <div class="modal-header">
                <h5 class="modal-title" id="addStatusModalLabel">View Repair Status</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form>

                    <div class="mb-3">
                        <label for="name" class="form-label">Name</label>
                        <input type="text" class="form-control bg-dark text-light border-secondary" id="name" name="name" required>
                    </div>
                    <div class="mb-3">
                        <label for="description" class="form-label">Description</label>
                        <textarea class="form-control bg-dark text-light border-secondary" id="description" name="description" rows="3"></textarea>
                    </div>
                    <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Close</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- View Make Modal -->
<div class="modal fade" id="ViewMakeModal" tabindex="-1" aria-labelledby="viewMakeModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content bg-dark text-light">
            <div class="modal-header">
                <h5 class="modal-title" id="addMakeModalLabel">View Make</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form>
                    <div class="mb-3">
                        <label for="make_name" class="form-label">Name</label>
                        <input type="text" class="form-control bg-dark text-light border-secondary" id="make_name" name="make_name" disabled>
                    </div>
                    <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Close</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- View Location Modal -->
<div class="modal fade" id="ViewLocationModal" tabindex="-1" aria-labelledby="viewLocationModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content bg-dark text-light">
            <div class="modal-header">
                <h5 class="modal-title" id="addLocationModalLabel">View Location</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form>

                    <div class="mb-3">
                        <label for="location_name" class="form-label">Name</label>
                        <input type="text" class="form-control bg-dark text-light border-secondary" id="location_name" name="location_name" required>
                    </div>
                    <div class="mb-3">
                        <label for="address" class="form-label">Address</label>
                        <textarea class="form-control bg-dark text-light border-secondary" id="address" name="address" rows="3" required></textarea>
                    </div>
                    <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Close</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- View Customer Modal -->
<div class="modal fade" id="ViewCustomerModal" tabindex="-1" aria-labelledby="viewCustomerModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content bg-dark text-light">
            <div class="modal-header">
                <h5 class="modal-title" id="addCustomerModalLabel">View Customer</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form>

                    <div class="mb-3">
                        <label for="first_name" class="form-label">First Name</label>
                        <input type="text" class="form-control bg-dark text-light border-secondary" id="first_name" name="first_name" disabled>
                    </div>
                    <div class="mb-3">
                        <label for="last_name" class="form-label">Last Name</label>
                        <input type="text" class="form-control bg-dark text-light border-secondary" id="last_name" name="last_name" disabled>
                    </div>
                    <div class="mb-3">
                        <label for="email" class="form-label">Email</label>
                        <input type="email" class="form-control bg-dark text-light border-secondary" id="email" name="email" disabled>
                    </div>
                    <div class="mb-3">
                        <label for="phone" class="form-label">Phone</label>
                        <input type="tel" class="form-control bg-dark text-light border-secondary" id="phone" name="phone" disabled>
                    </div>
                    <div class="mb-3">
                        <label for="postcode" class="form-label">Post Code</label>
                        <input type="tel" class="form-control bg-dark text-light border-secondary" id="postcode" name="postcode" disabled>
                    </div>
                    <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Close</button>
                </form>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="ViewRepairModal" tabindex="-1" aria-labelledby="vddRepairModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-scrollable modal-lg">
        <div class="modal-content bg-dark text-light">
            <div class="modal-header">
                <h5 class="modal-title" id="ViewRepairModalLabel">View Repair</h5>
                <button type="button" class="btn-close btn-close-white" onclick="closeModal()"></button>
            </div>
            <script>
    function closeModal() {
        // Close the modal
        const modal = document.getElementById('ViewRepairModal'); // Replace 'yourModalId' with the actual modal ID
        if (modal) {
            modal.style.display = 'none'; // Hide the modal (you can adjust this based on your modal structure)
            repair_id = ""
        }

        // Reload the page
        window.location.reload(); // Reloads the page
    }
</script>
            <div class="modal-body">
                <form>
                    <!-- Form Fields -->
                     <h4>Device Info</h4>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="customer" class="form-label">Customer</label>
                            <input type="text" class="form-control bg-dark text-light border-secondary" id="customer" name="customer">
                        </div>

                        <div class="col-md-6 mb-3">
                            <label for="device_type" class="form-label">Device Type</label>
                            <input type="text" class="form-control bg-dark text-light border-secondary" id="device_type" name="device_type">
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="make" class="form-label">Make</label>
                            <input type="text" class="form-control bg-dark text-light border-secondary" id="make" name="make" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="model" class="form-label">Model</label>
                            <input type="text" class="form-control bg-dark text-light border-secondary" id="model" name="model" required>
                        </div>
                    </div>
                    
                    <div id="mobile-tablet-fields" class="d-none">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="imei" class="form-label">IMEI</label>
                                <input type="text" class="form-control bg-dark text-light border-secondary" id="imei" name="imei">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="network" class="form-label">Network</label>
                                <input type="text" class="form-control bg-dark text-light border-secondary" id="network" name="network">
                            </div>
                        </div>
                        <h4>Diagnostic Data</h4>

                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label">Risk Lcd</label>
                                <div class="d-flex">
                                    <div class="form-check me-3">
                                        <input class="form-check-input" type="radio" name="risk_lcd" id="risk_lcd-yes" disabled>
                                        <label class="form-check-label" for="risk_lcd-yes">Yes</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="risk_lcd" id="risk_lcd-no" value="False" disabled>
                                        <label class="form-check-label" for="risk_lcd-no">No</label>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Sim Removed</label>
                                <div class="d-flex">
                                    <div class="form-check me-3">
                                        <input class="form-check-input" type="radio" name="sim_removed" id="sim_removed-yes" disabled>
                                        <label class="form-check-label" for="sim_removed-yes">Yes</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="sim_removed" id="sim_removed-no" value="False" disabled>
                                        <label class="form-check-label" for="sim_removed-no">No</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label">Button Function Ok</label>
                                <div class="d-flex">
                                    <div class="form-check me-3">
                                        <input class="form-check-input" type="radio" name="button_function_ok" id="button_function_ok-yes" disabled>
                                        <label class="form-check-label" for="button_function_ok-yes">Yes</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="button_function_ok" id="button_function_ok-no" value="False" disabled>
                                        <label class="form-check-label" for="button_function_ok-no">No</label>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Risk Biometric</label>
                                <div class="d-flex">
                                    <div class="form-check me-3">
                                        <input class="form-check-input" type="radio" name="risk_biometric" id="risk_biometric-yes" disabled>
                                        <label class="form-check-label" for="risk_biometric-yes">Yes</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="risk_biometric" id="risk_biometric-no" disabled>
                                        <label class="form-check-label" for="risk_biometric-no">No</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label">Risk Back</label>
                                <div class="d-flex">
                                    <div class="form-check me-3">
                                        <input class="form-check-input" type="radio" name="risk_back" id="risk_back-yes" disabled>
                                        <label class="form-check-label" for="risk_back-yes">Yes</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="risk_back" id="risk_back-no" value="False" disabled>
                                        <label class="form-check-label" for="risk_back-no">No</label>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Camera Lens/Back Damage</label>
                                <div class="d-flex">
                                    <div class="form-check me-3">
                                        <input class="form-check-input" type="radio" name="camera_lens_back_damage" id="camera_lens_back_damage-yes" disabled>
                                        <label class="form-check-label" for="camera_lens_back_damage-yes">Yes</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="camera_lens_back_damage" id="camera_lens_back_damage-no" value="False" disabled>
                                        <label class="form-check-label" for="camera_lens_back_damage-no">No</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label">Lens Lcd Damage</label>
                                <div class="d-flex">
                                    <div class="form-check me-3">
                                        <input class="form-check-input" type="radio" name="lens_lcd_damage" id="lens_lcd_damage-yes" disabled>
                                        <label class="form-check-label" for="lens_lcd_damage-yes">Yes</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="lens_lcd_damage" id="lens_lcd_damage-no" value="False" disabled>
                                        <label class="form-check-label" for="lens_lcd_damage-no">No</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                        





                    </div>
                    <div id="laptop-fields" style="display: none;">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="operating_system" class="form-label">Operating System</label>
                                <input type="text" class="form-control bg-dark text-light border-secondary" id="operating_system" name="operating_system">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="ram" class="form-label">RAM</label>
                                <input type="text" class="form-control bg-dark text-light border-secondary" id="ram" name="ram">
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="storage" class="form-label">Storage</label>
                                <input type="text" class="form-control bg-dark text-light border-secondary" id="storage" name="storage">
                            </div>
                        </div>
                        <h4>Diagnostic Data</h4>

                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label">Screen Damage</label>
                                <div class="d-flex">
                                    <div class="form-check me-3">
                                        <input class="form-check-input" type="radio" name="screen_damage" id="screen_damage-yes" value="True" disabled>
                                        <label class="form-check-label" for="screen_damage-yes">Yes</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="screen_damage" id="screen_damage-no" value="False" disabled>
                                        <label class="form-check-label" for="screen_damage-no">No</label>
                                    </div>
                                </div>
                            </div>
                        
                        
                            <div class="col-md-6">
                                <label class="form-label">Hinge Damage</label>
                                <div class="d-flex">
                                    <div class="form-check me-3">
                                        <input class="form-check-input" type="radio" name="hinge_damage" id="hinge_damage-yes" value="True" disabled>
                                        <label class="form-check-label" for="hinge_damage-yes">Yes</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="hinge_damage" id="hinge_damage-no" value="False" disabled>
                                        <label class="form-check-label" for="hinge_damage-no">No</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label">Keyboard Functional</label>
                                <div class="d-flex">
                                    <div class="form-check me-3">
                                        <input class="form-check-input" type="radio" name="keyboard_functional" id="keyboard_functional-yes" value="True" disabled>
                                        <label class="form-check-label" for="keyboard_functional-yes">Yes</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="keyboard_functional" id="keyboard_functional-no" value="False" disabled>
                                        <label class="form-check-label" for="keyboard_functional-no">No</label>
                                    </div>
                                </div>
                            </div>
                        
                            <div class="col-md-6">
                                <label class="form-label">Trackpad Working</label>
                                <div class="d-flex">
                                    <div class="form-check me-3">
                                        <input class="form-check-input" type="radio" name="trackpad_functional" id="trackpad_functional-yes" value="True" disabled>
                                        <label class="form-check-label" for="trackpad_functional-yes">Yes</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="trackpad_functional" id="trackpad_functional-no" value="False" disabled>
                                        <label class="form-check-label" for="trackpad_functional-no">No</label>
                                    </div>
                                </div>
                            </div>
                        </div>


                    </div>


                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">Tampered</label>
                            <div class="d-flex">
                                <div class="form-check me-3">
                                    <input class="form-check-input" type="radio" name="tampered" id="tampered-yes" value="True" disabled>
                                    <label class="form-check-label" for="tampered-yes">Yes</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="tampered" id="tampered-no" value="False" disabled>
                                    <label class="form-check-label" for="tampered-no">No</label>
                                </div>
                            </div>
                        </div>
                    
                        <div class="col-md-6">
                            <label class="form-label">Missing Parts</label>
                            <div class="d-flex">
                                <div class="form-check me-3">
                                    <input class="form-check-input" type="radio" name="missing_part" id="missing_part-yes" value="True" disabled>
                                    <label class="form-check-label" for="missing_part-yes">Yes</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="missing_part" id="missing_part-no" value="False" disabled>
                                    <label class="form-check-label" for="missing_part-no">No</label>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">Power Up</label>
                            <div class="d-flex">
                                <div class="form-check me-3">
                                    <input class="form-check-input" type="radio" name="power_up" id="power_up-yes" value="True" disabled>
                                    <label class="form-check-label" for="{{ field }}-yes">Yes</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="power_up" id="power_up-no" value="False" disabled>
                                    <label class="form-check-label" for="power_up-no">No</label>
                                </div>
                            </div>
                        </div>
                    
                        <div class="col-md-6">
                            <label class="form-label">Liquid Damage</label>
                            <div class="d-flex">
                                <div class="form-check me-3">
                                    <input class="form-check-input" type="radio" name="liquid_damage" id="liquid_damage-yes" value="True" disabled>
                                    <label class="form-check-label" for="liquid_damage-yes">Yes</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="liquid_damage" id="liquid_damage-no" value="False" disabled>
                                    <label class="form-check-label" for="liquid_damage-no">No</label>
                                </div>
                            </div>
                        </div>
                    </div>
                    <h4>Repair Status</h4>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="status" class="form-label">Status</label>
                            <select class="form-control bg-dark text-light border-secondary" id="status" name="status" required>
                                {% for status in repair_statuses %}
                                    <option value="{{ status.id }}">{{ status.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="passcode" class="form-label">Passcode</label>
                            <input type="number" step="0.01" class="form-control bg-dark text-light border-secondary" id="passcode" name="passcode" required>
                        </div>
                        
                    </div>
                    <div class="row">
                        
                        <div class="col-md-6 mb-3">
                            <label for="finalized_price" class="form-label">Site </label>
                            <input type="text" class="form-control bg-dark text-light border-secondary" id="site_repair" name="site_repair" disabled>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="location" class="form-label">Location</label>
                                <select class="form-control bg-dark text-light border-secondary" id="location" name="location" required>
                                    <option value="" disabled selected>Select a Location</option>
                                </select>
                            </div>

                    </div>
                    <h4>Costs</h4>
                    <div class="row">
                        
                        <div class="col-md-6 mb-3">
                            <label for="estimated_cost" class="form-label">Estimated Cost</label>
                            <input type="number" step="0.01" class="form-control bg-dark text-light border-secondary" id="estimated_cost" name="estimated_cost" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="finalized_price" class="form-label">Finalized Cost</label>
                            <input type="number" step="0.01" class="form-control bg-dark text-light border-secondary" id="finalized_price" name="finalized" >
                        </div>

                    </div>
                    <!-- Estimated Cost and Signature -->
                    
                    <div class="row">
                        
                        <div class="col mb-3">
                            <label for="issue_description" class="form-label">Issue Description</label>
                            <textarea class="form-control bg-dark text-light border-secondary" id="issue_description" name="issue_description" rows="3" required></textarea>
                        </div>
                    </div>
                    <div class="row">
    <div class="col-md-12 mb-3">
        <label for="notes" class="form-label">Technician Notes</label>

        <div id="notes" class="note-container">

            </div>
            <div id="note-input-container" class="mt-2">
                <textarea class="form-control bg-dark text-light border-secondary mb-2" id="new-note" placeholder="Write your note here"></textarea>
                <div id="actions-container" class="row mt-2">
                    <div class=" mb-3 col-md-6">
                        <input type="checkbox" class="form-check-input" id="sendAsSms" name="sendAsSms">
                        <label for="sendAsSms" class="form-check-label">Send as SMS</label>
                    </div>
                    <div class=" mb-3 col-md-6">
                        <input type="checkbox" class="form-check-input" id="sendAsEmail" name="sendAsEmail">
                        <label for="sendAsEmail" class="form-check-label">Send as Email</label>
                    </div>
                </div>
                <button type="button" class="btn btn-success btn-sm mt-1" onclick="addNote()">Done</button>
            </div>



    </div>
</div>


                    <!-- Submit Button -->
                    <div class="mb-3">
                        <button type="button" class="btn btn-primary w-100" onclick="closeModal()">Close</button>
                    </div>
                </form>
            </div>
            <div class="modal-footer" style="margin-top: auto;"></div>
        </div>
    </div>
</div>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        var ctx = document.getElementById('repairsChart').getContext('2d');
        var chart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'],
                datasets: [{
                    label: 'Repairs',
                    data: [12, 19, 3, 5, 2, 3],
                    borderColor: 'rgb(75, 192, 192)',
                    tension: 0.1
                }]
            },
            options: {
                responsive: true,
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
    
        
    });
    let repair_id = ""
    function addNote() {
        if (repair_id === ""){
            alert("Something went wrong")

        }
    const newNote = document.getElementById("new-note").value.trim();
    if (newNote) {
        // Add the note to the repair's notes array
        
        const status = document.getElementById(`status`).value;
        const locationElement  = document.getElementById(`location`).value;
    const finalizedElement  = document.getElementById(`finalized_price`).value;

    const send_sms  = document.getElementById(`sendAsSms`).checked;
    const send_email  = document.getElementById(`sendAsEmail`).checked;
    let allNotes = [newNote]; // Start with the new notes

    // Get existing notes from the DOM that are not part of newNotes
    

    // Filter out notes that are already in newNotes (to prevent duplicates)
    

    // Combine new notes with filtered existing notes
    


        // Send the notes to the backend
        fetch('/repairs/save-notes/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}',
            },
            body: JSON.stringify({
                repair_id: repair_id, // Send the repair id
                notes: allNotes,
                finalized: finalizedElement,
                status: status, // Include selected status
                location1: locationElement, // Include selected location
                send_sms: send_sms,
                send_email: send_email
            }),
        })
        .then(response => response.json())
        .then(data => {
    if (data.success) {
        alert("Notes saved successfully!");
        document.getElementById("new-note").value=""

        const notesDiv = document.getElementById('notes');

        // Clear the notesDiv before appending new notes
        notesDiv.innerHTML = "";

        if (data.data && data.data.length > 0) {
            // Loop through the notes and create cards
            data.data.forEach((note, index) => {
                // Create card container
                const cardDiv = document.createElement('div');
                cardDiv.classList.add('card', 'border-dark', 'bg-dark', 'text-light', 'mb-3');
                cardDiv.id = `note${index + 1}`;

                // Create card body
                const cardBody = document.createElement('div');
                cardBody.classList.add('card-body');

                // Add Note #
                const noteNumber = document.createElement('p');
                noteNumber.classList.add('text-light-50', 'mb-2');
                noteNumber.innerHTML = `<strong>Note #${index + 1}:</strong>`;
                cardBody.appendChild(noteNumber);

                // Add Note Text
                const noteText = document.createElement('p');
                noteText.classList.add('form-control', 'bg-dark', 'text-light', 'border-secondary', 'mb-2');
                noteText.id = `note-text-${index}`;
                noteText.textContent = note.note || 'No note provided.';
                cardBody.appendChild(noteText);

                // Attributes row
                const attributesRow = document.createElement('div');
                attributesRow.classList.add('d-flex', 'flex-wrap', 'align-items-center', 'text-light-50', 'mb-2');

                // Add User (if available)
                if (note.user) {
                    const userText = document.createElement('small');
                    userText.classList.add('me-3', 'd-flex', 'align-items-center');
                    userText.innerHTML = `<i class="fa fa-user me-1"></i> ${note.user}`;
                    attributesRow.appendChild(userText);
                }

                // Add Date and Time
                const dateTime = document.createElement('small');
                dateTime.classList.add('me-3', 'd-flex', 'align-items-center');
                dateTime.innerHTML = `<i class="fa fa-clock me-1"></i> ${note.time ? note.time.slice(0, 16) : 'N/A'}`;
                attributesRow.appendChild(dateTime);

                // Add Delivery Method
                const deliveryMethod = document.createElement('small');
                deliveryMethod.classList.add('d-flex', 'align-items-center');
                let deliveryText = `<i class="fa fa-envelope me-1"></i> `;
                if (note.send_email && note.send_sms) {
                    deliveryText += 'Email & SMS';
                } else if (note.send_email) {
                    deliveryText += 'Email';
                } else if (note.send_sms) {
                    deliveryText += 'SMS';
                } else {
                    deliveryText += 'Not Sent';
                }
                deliveryMethod.innerHTML = deliveryText;
                attributesRow.appendChild(deliveryMethod);

                // cardBody.appendChild(attributesRow);

                // Add Changes (if available)
                if (note.changes && note.changes.length > 0) {
                    const changesDiv = document.createElement('div');
                    changesDiv.classList.add('d-flex', 'flex-wrap', 'mt-2');
                    changesDiv.style.marginLeft = '10px';

                    const changesTitle = document.createElement('p');
                    changesTitle.classList.add('mb-1', 'me-1');
                    changesTitle.innerHTML = '<strong>Changes:</strong>';
                    changesDiv.appendChild(changesTitle);

                    const changesList = document.createElement('ul');
                    changesList.classList.add('list-inline', 'mb-0');

                    note.changes.forEach(change => {
                        const changeItem = document.createElement('li');
                        changeItem.classList.add('list-inline-item');
                        changeItem.innerHTML = `<strong>${change.field}:</strong> ${change.before} → ${change.after}`;
                        changesList.appendChild(changeItem);
                    });

                    changesDiv.appendChild(changesList);
                    attributesRow.appendChild(changesDiv);
                }
                cardBody.appendChild(attributesRow);

                cardDiv.appendChild(cardBody);
                notesDiv.appendChild(cardDiv);
                
            });

        } else {
            // If no notes, add a <p> tag with the value "No notes"
            const pTag = document.createElement('p');
            pTag.textContent = "No notes"; // Text to display if there are no notes
            notesDiv.appendChild(pTag); // Append the <p> tag to the notes div
        }
        
        
    } else {
        alert("Failed to save notes. Please try again.");
    }
})
.catch(error => console.error('Error:', error));



    } else {
        alert("Please write a note before clicking Done.");
    }
}
</script>
{% endblock %}
